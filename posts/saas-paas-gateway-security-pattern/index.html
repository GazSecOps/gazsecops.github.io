<!doctype html><html lang=en><head><title>SaaS + PaaS Gateway Security Pattern: Trust Boundaries and Data Sovereignty :: Gareth's Engineering Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="When third-party SaaS platforms need to display real-time data from your Azure services, a PaaS API gateway creates a critical security boundary. This guide explains why this architecture is best practice and how to implement it securely."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://gazsecops.github.io/posts/saas-paas-gateway-security-pattern/><link rel=stylesheet href=https://gazsecops.github.io/css/extended.min.c658c723e006469d82f697e19c5338967fad12c57650bdd915bacf9cfbe2cc38.css><link rel=stylesheet href=https://gazsecops.github.io/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css><link rel=stylesheet href=https://gazsecops.github.io/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css><link rel=stylesheet href=https://gazsecops.github.io/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css><link rel=stylesheet href=https://gazsecops.github.io/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css><link rel=stylesheet href=https://gazsecops.github.io/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css><link rel=stylesheet href=https://gazsecops.github.io/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css><link rel=stylesheet href=https://gazsecops.github.io/css/main.min.36833afd348409fc6c3d09d0897c5833d9d5bf1ff31f5e60ea3ee42ce2b1268c.css><link rel=stylesheet href=https://gazsecops.github.io/css/menu.min.3c17467ebeb3d38663dce68f71f519901124fa5cbb4519b2fb0667a21e9aca39.css><link rel=stylesheet href=https://gazsecops.github.io/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css><link rel=stylesheet href=https://gazsecops.github.io/css/post.min.e6dddd258e64c83e05cec0cd49c05216742d42fc8ecbfbe6b67083412b609bd3.css><link rel=stylesheet href=https://gazsecops.github.io/css/syntax.min.a0773cce9310cb6d8ed23e50f005448facf29a53001b57e038828daa466b25c0.css><link rel=stylesheet href=https://gazsecops.github.io/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css><link rel=stylesheet href=https://gazsecops.github.io/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css><link rel="shortcut icon" href=https://gazsecops.github.io/favicon.png><link rel=apple-touch-icon href=https://gazsecops.github.io/apple-touch-icon.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="SaaS + PaaS Gateway Security Pattern: Trust Boundaries and Data Sovereignty"><meta property="og:description" content="When third-party SaaS platforms need to display real-time data from your Azure services, a PaaS API gateway creates a critical security boundary. This guide explains why this architecture is best practice and how to implement it securely."><meta property="og:url" content="https://gazsecops.github.io/posts/saas-paas-gateway-security-pattern/"><meta property="og:site_name" content="Gareth's Engineering Blog"><meta property="og:image" content="https://gazsecops.github.io/og-image.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2026-02-11 16:00:00 +0000 UTC"></head><body><div class="container center"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>gareth@blog:~$</div></a></div><div class=header__search><input type=text id=header-search placeholder="Quick search..." style="padding:5px 10px;background:#222;color:#eee;border:1px solid #444;border-radius:3px;font-size:14px;width:200px"></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/topics/>Topics</a></li><li><a href=/posts/>All</a></li><li><a href=/series/>Series</a></li><li><a href=/tags/>Tags</a></li><li><a href=/archive/>Archive</a></li><li><a href=/search/>Search</a></li><li><a href=/about/>About</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/topics/>Topics</a></li><li><a href=/posts/>All</a></li><li><a href=/series/>Series</a></li><li><a href=/tags/>Tags</a></li><li><a href=/archive/>Archive</a></li><li><a href=/search/>Search</a></li><li><a href=/about/>About</a></li></ul></nav></header><script>(function(){const e=document.getElementById("header-search");if(!e)return;e.addEventListener("keydown",function(e){if(e.key==="Enter"){const e=this.value.trim();e&&(window.location.href="/search?q="+encodeURIComponent(e))}}),document.addEventListener("keydown",function(t){t.key==="/"&&!["INPUT","TEXTAREA"].includes(t.target.tagName)&&(t.preventDefault(),e.focus()),t.key==="Escape"&&t.target===e&&e.blur()})})()</script><style>.header__inner{display:flex;align-items:center;gap:20px}.header__search{flex:none}#header-search::placeholder{color:#666;font-style:italic}#header-search:focus{outline:none;border-color:#888}@media(max-width:684px){.header__search{display:none}}</style><div class=content><article class=post><h1 class=post-title><a href=https://gazsecops.github.io/posts/saas-paas-gateway-security-pattern/>SaaS + PaaS Gateway Security Pattern: Trust Boundaries and Data Sovereignty</a></h1><div class=post-meta><time class=post-date>2026-02-11</time><span class=post-author>Gareth</span><span class=post-reading-time>12 min read (2459 words)</span></div><span class=post-tags>#<a href=https://gazsecops.github.io/tags/azure/>azure</a>&nbsp;
#<a href=https://gazsecops.github.io/tags/security/>security</a>&nbsp;
#<a href=https://gazsecops.github.io/tags/saas/>saas</a>&nbsp;
#<a href=https://gazsecops.github.io/tags/architecture/>architecture</a>&nbsp;
#<a href=https://gazsecops.github.io/tags/api-gateway/>api-gateway</a>&nbsp;
#<a href=https://gazsecops.github.io/tags/trust-boundary/>trust-boundary</a>&nbsp;</span><div class=table-of-contents><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#the-architecture>The Architecture</a></li><li><a href=#why-this-is-best-practice>Why This IS Best Practice</a><ul><li><a href=#1-trust-boundary>1. Trust Boundary</a></li><li><a href=#2-zero-trust-architecture>2. Zero Trust Architecture</a></li><li><a href=#3-single-point-of-enforcement>3. Single Point of Enforcement</a></li><li><a href=#4-data-sovereignty-and-compliance>4. Data Sovereignty and Compliance</a></li><li><a href=#5-vendor-independence>5. Vendor Independence</a></li></ul></li><li><a href=#request-flow-step-by-step>Request Flow: Step by Step</a><ul><li><a href=#step-1-authentication>Step 1: Authentication</a></li><li><a href=#step-2-data-request>Step 2: Data Request</a></li><li><a href=#step-3-gateway-validation>Step 3: Gateway Validation</a></li><li><a href=#step-4-azure-service-access>Step 4: Azure Service Access</a></li><li><a href=#step-5-response-and-logging>Step 5: Response and Logging</a></li></ul></li><li><a href=#security-threats-and-mitigations>Security Threats and Mitigations</a><ul><li><a href=#threat-1-token-theft>Threat 1: Token Theft</a></li><li><a href=#threat-2-gateway-compromise>Threat 2: Gateway Compromise</a></li><li><a href=#threat-3-saas-side-channel-attacks>Threat 3: SaaS Side-Channel Attacks</a></li><li><a href=#threat-4-privilege-escalation-via-scopes>Threat 4: Privilege Escalation via Scopes</a></li></ul></li><li><a href=#implementation-patterns>Implementation Patterns</a><ul><li><a href=#pattern-1-multi-saas-gateway>Pattern 1: Multi-SaaS Gateway</a></li><li><a href=#pattern-2-gateway-per-tenant>Pattern 2: Gateway per Tenant</a></li><li><a href=#pattern-3-direct-integration-gateway-skip>Pattern 3: Direct Integration (Gateway Skip)</a></li></ul></li><li><a href=#best-practices-for-secure-implementation>Best Practices for Secure Implementation</a><ul><li><a href=#1-use-managed-identities>1. Use Managed Identities</a></li><li><a href=#2-implement-token-caching-with-invalidation>2. Implement Token Caching (With Invalidation)</a></li><li><a href=#3-implement-comprehensive-logging>3. Implement Comprehensive Logging</a></li><li><a href=#4-rate-limiting-strategy>4. Rate Limiting Strategy</a></li><li><a href=#5-input-validation-and-sanitization>5. Input Validation and Sanitization</a></li><li><a href=#6-circuit-breaker-pattern>6. Circuit Breaker Pattern</a></li></ul></li><li><a href=#monitoring-and-observability>Monitoring and Observability</a><ul><li><a href=#key-metrics-to-track>Key Metrics to Track</a></li><li><a href=#alerting-strategy>Alerting Strategy</a></li></ul></li><li><a href=#common-pitfalls-to-avoid>Common Pitfalls to Avoid</a><ul><li><a href=#pitfall-1-long-lived-tokens>Pitfall 1: Long-Lived Tokens</a></li><li><a href=#pitfall-2-over-scoped-tokens>Pitfall 2: Over-Scoped Tokens</a></li><li><a href=#pitfall-3-skipping-input-validation>Pitfall 3: Skipping Input Validation</a></li><li><a href=#pitfall-4-no-per-client-monitoring>Pitfall 4: No Per-Client Monitoring</a></li><li><a href=#pitfall-5-hard-coded-secrets>Pitfall 5: Hard-Coded Secrets</a></li></ul></li><li><a href=#performance-considerations>Performance Considerations</a><ul><li><a href=#gateway-as-bottleneck>Gateway as Bottleneck?</a></li><li><a href=#scaling-your-gateway>Scaling Your Gateway</a></li></ul></li><li><a href=#conclusion-why-this-pattern-works>Conclusion: Why This Pattern Works</a></li></ul></nav></div><div class=post-content><div><h1 id=saas--paas-gateway-security-pattern-trust-boundaries-and-data-sovereignty>SaaS + PaaS Gateway Security Pattern: Trust Boundaries and Data Sovereignty<a href=#saas--paas-gateway-security-pattern-trust-boundaries-and-data-sovereignty class=hanchor arialabel=Anchor>#</a></h1><p>Modern SaaS platforms often need to integrate with customer data stored in Azure. The user logs into the SaaS UI, but the actual data lives in the customer&rsquo;s Azure subscription. How do you provide real-time access without storing customer data in the SaaS database?</p><p>The answer: a PaaS API gateway that acts as a controlled bridge.</p><h2 id=the-architecture>The Architecture<a href=#the-architecture class=hanchor arialabel=Anchor>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-text data-lang=text><span style=display:flex><span>Third-Party SaaS Platform
</span></span><span style=display:flex><span>   (You don&#39;t control, don&#39;t store data)
</span></span><span style=display:flex><span>            ↓
</span></span><span style=display:flex><span>      OAuth / JWT / API Key (Authentication)
</span></span><span style=display:flex><span>            ↓
</span></span><span style=display:flex><span>Your PaaS API Gateway
</span></span><span style=display:flex><span>   (You control this middle layer)
</span></span><span style=display:flex><span>            ↓
</span></span><span style=display:flex><span>Azure Services - Your Tenant
</span></span><span style=display:flex><span>   → Cosmos DB (stores data)
</span></span><span style=display:flex><span>   → SQL Database (stores data)
</span></span><span style=display:flex><span>   → Azure Blob Storage (files)
</span></span><span style=display:flex><span>   → Azure Key Vault (secrets)
</span></span><span style=display:flex><span>            ↓
</span></span><span style=display:flex><span>      Validated Response (Logged)
</span></span><span style=display:flex><span>            ↓
</span></span><span style=display:flex><span>      Data sent to SaaS Web UI for display
</span></span></code></pre></div><h2 id=why-this-is-best-practice>Why This IS Best Practice<a href=#why-this-is-best-practice class=hanchor arialabel=Anchor>#</a></h2><h3 id=1-trust-boundary>1. Trust Boundary<a href=#1-trust-boundary class=hanchor arialabel=Anchor>#</a></h3><p><strong>Data never touches SaaS storage.</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>SaaS Compromised:
</span></span><span style=display:flex><span>  → Attacker gets SaaS database
</span></span><span style=display:flex><span>  → ❌ NO sensitive user data (stored in your Azure)
</span></span><span style=display:flex><span>  → Only: SaaS metadata, session tokens
</span></span><span style=display:flex><span>  → Attacker sees nothing valuable
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Your Azure API Gateway Compromised:
</span></span><span style=display:flex><span>  → Attacker has access to your tenant
</span></span><span style=display:flex><span>  → ✅ All sensitive data is exposed
</span></span><span style=display:flex><span>  → But: You control gateway, you can detect/respond
</span></span></code></pre></div><p><strong>Security benefit:</strong> SaaS being hacked doesn&rsquo;t expose your customer data. Attackers hit a wall - they only see the SaaS&rsquo;s own data, not your customers'.</p><h3 id=2-zero-trust-architecture>2. Zero Trust Architecture<a href=#2-zero-trust-architecture class=hanchor arialabel=Anchor>#</a></h3><p><strong>Every data request is authenticated and authorized.</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>SaaS → Your API Gateway:
</span></span><span style=display:flex><span>  → Validates: OAuth token / API key
</span></span><span style=display:flex><span>  → Checks: Rate limiting, IP restrictions
</span></span><span style=display:flex><span>  → Logs: Every request
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Your API Gateway → Azure Services:
</span></span><span style=display:flex><span>  → Validates: Managed identity permissions
</span></span><span style=display:flex><span>  → Checks: Scope-based access
</span></span><span style=display:flex><span>  → Logs: Every data access
</span></span></code></pre></div><p><strong>Security benefit:</strong> No implicit trust. Every request is explicitly authorized at your gateway before reaching your services. The SaaS can&rsquo;t make unauthorized requests - your gateway blocks them.</p><h3 id=3-single-point-of-enforcement>3. Single Point of Enforcement<a href=#3-single-point-of-enforcement class=hanchor arialabel=Anchor>#</a></h3><p><strong>You control gateway security - the SaaS doesn&rsquo;t decide who accesses what.</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>Security Controls - At Your API Gateway
</span></span><span style=display:flex><span>   • Rate limiting per SaaS client
</span></span><span style=display:flex><span>   • IP whitelisting/blacklisting
</span></span><span style=display:flex><span>   • Real-time anomaly detection
</span></span><span style=display:flex><span>   • Per-tenant data isolation
</span></span><span style=display:flex><span>   • Request/response logging
</span></span><span style=display:flex><span>   • Custom authorization logic
</span></span></code></pre></div><p><strong>Security benefit:</strong> You control enforcement. If the SaaS&rsquo;s frontend has a bug that tries to bypass controls, your gateway rejects the request. Frontend bugs can&rsquo;t compromise backend security.</p><h3 id=4-data-sovereignty-and-compliance>4. Data Sovereignty and Compliance<a href=#4-data-sovereignty-and-compliance class=hanchor arialabel=Anchor>#</a></h3><p><strong>Data stays in your tenant.</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>Scenario: GDPR compliance
</span></span><span style=display:flex><span>  Customer data stored: Your Azure subscription
</span></span><span style=display:flex><span>  Data location: Your chosen region (UK, EU, US)
</span></span><span style=display:flex><span>  Data access logging: Your Log Analytics workspace
</span></span><span style=display:flex><span>  Data retention: You control deletion policies
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vs.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Scenario: Data stored on SaaS
</span></span><span style=display:flex><span>  Customer data stored: SaaS provider&#39;s systems
</span></span><span style=display:flex><span>  Data location: Wherever SaaS chose (could be anywhere)
</span></span><span style=display:flex><span>  Data access logging: SaaS provider&#39;s logs
</span></span><span style=display:flex><span>  Data retention: SaaS provider&#39;s policies
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>→ ✅ You can prove compliance
</span></span></code></pre></div><p><strong>Security benefit:</strong> You control data residency, retention policies, and audit trails. You can prove to regulators that you&rsquo;re meeting requirements.</p><h3 id=5-vendor-independence>5. Vendor Independence<a href=#5-vendor-independence class=hanchor arialabel=Anchor>#</a></h3><p><strong>You&rsquo;re not locked into the SaaS.</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>Current Setup:
</span></span><span style=display:flex><span>  SaaS + Azure PaaS Gateway + Your Azure Services
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>If SaaS has issues:
</span></span><span style=display:flex><span>  → Security vulnerability
</span></span><span style=display:flex><span>  → Downtime
</span></span><span style=display:flex><span>  → Price increase
</span></span><span style=display:flex><span>  → Non-compliance with regulations
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>You can:
</span></span><span style=display:flex><span>  → Switch PaaS gateway to different SaaS
</span></span><span style=display:flex><span>  → Or build your own SaaS frontend
</span></span><span style=display:flex><span>  → Your Azure services continue unchanged
</span></span><span style=display:flex><span>  → No data migration needed
</span></span></code></pre></div><p><strong>Security benefit:</strong> Avoid vendor lock-in. If the SaaS vendor becomes problematic, you can switch providers without moving data.</p><h2 id=request-flow-step-by-step>Request Flow: Step by Step<a href=#request-flow-step-by-step class=hanchor arialabel=Anchor>#</a></h2><h3 id=step-1-authentication>Step 1: Authentication<a href=#step-1-authentication class=hanchor arialabel=Anchor>#</a></h3><p>The SaaS authenticates to your PaaS API gateway:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#75715e>// The SaaS requests an access token
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>POST</span> <span style=color:#960050;background-color:#1e0010>/oauth/token</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;client_id&#34;</span>: <span style=color:#e6db74>&#34;saas-client-123&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;client_secret&#34;</span>: <span style=color:#e6db74>&#34;saas-secret-xxx&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;grant_type&#34;</span>: <span style=color:#e6db74>&#34;client_credentials&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;scope&#34;</span>: <span style=color:#e6db74>&#34;read:customer_data&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Response:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;access_token&#34;</span>: <span style=color:#e6db74>&#34;eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIs...&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;token_type&#34;</span>: <span style=color:#e6db74>&#34;Bearer&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;expires_in&#34;</span>: <span style=color:#ae81ff>3600</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;scope&#34;</span>: <span style=color:#e6db74>&#34;read:customer_data&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Key point:</strong> The SaaS gets a <strong>scoped, short-lived token</strong> - not full access to your Azure services.</p><h3 id=step-2-data-request>Step 2: Data Request<a href=#step-2-data-request class=hanchor arialabel=Anchor>#</a></h3><p>The SaaS requests data using the access token:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>GET /api/customers/{customerId}/orders
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>Host: api.your-company.com
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIs...
</span></span></span></code></pre></div><h3 id=step-3-gateway-validation>Step 3: Gateway Validation<a href=#step-3-gateway-validation class=hanchor arialabel=Anchor>#</a></h3><p>Your gateway validates every request:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// Your API Gateway middleware
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>headers</span>.<span style=color:#a6e22e>authorization</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#39;Bearer &#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 1. Validate token
</span></span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#66d9ef>await</span> <span style=color:#a6e22e>validateToken</span>(<span style=color:#a6e22e>token</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>401</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Invalid token&#39;</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 2. Check rate limits
</span></span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>clientId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>decodeToken</span>(<span style=color:#a6e22e>token</span>).<span style=color:#a6e22e>client_id</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>await</span> <span style=color:#a6e22e>isRateLimited</span>(<span style=color:#a6e22e>clientId</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>429</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Rate limit exceeded&#39;</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 3. Check IP restrictions (if configured)
</span></span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>await</span> <span style=color:#a6e22e>isIPBlocked</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>ip</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>403</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;IP not authorized&#39;</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 4. Check scope
</span></span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>decoded</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>decodeToken</span>(<span style=color:#a6e22e>token</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>decoded</span>.<span style=color:#a6e22e>scope</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#e6db74>&#39;read:customer_data&#39;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>403</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Insufficient scope&#39;</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>next</span>();
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p><strong>Key point:</strong> Multiple layers of validation before the request reaches your data.</p><h3 id=step-4-azure-service-access>Step 4: Azure Service Access<a href=#step-4-azure-service-access class=hanchor arialabel=Anchor>#</a></h3><p>The gateway uses managed identity to access Azure services:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// Gateway fetches data from Cosmos DB
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>cosmos</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;@azure/cosmos-db&#39;</span>).<span style=color:#a6e22e>CosmosClient</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>container</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>cosmos</span>.<span style=color:#a6e22e>database</span>(<span style=color:#e6db74>&#39;CustomerData&#39;</span>).<span style=color:#a6e22e>container</span>(<span style=color:#e6db74>&#39;Customers&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>resources</span> } <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>container</span>.<span style=color:#a6e22e>items</span>
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>query</span>(<span style=color:#e6db74>`SELECT * FROM c WHERE c.id = @customerId`</span>, {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>parameters</span><span style=color:#f92672>:</span> [{ <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;@customerId&#39;</span>, <span style=color:#a6e22e>value</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>customerId</span> }]
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>fetchAll</span>();
</span></span></code></pre></div><p><strong>Key point:</strong> No connection strings or secrets. The gateway uses managed identity with specific RBAC permissions.</p><h3 id=step-5-response-and-logging>Step 5: Response and Logging<a href=#step-5-response-and-logging class=hanchor arialabel=Anchor>#</a></h3><p>The gateway logs everything:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// Before sending response
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>await</span> <span style=color:#a6e22e>logToAnalytics</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>timestamp</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> Date(),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>saas_client</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>clientId</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>customer_id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>customerId</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>action</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;READ_CUSTOMER_ORDERS&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>data_accessed</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>resources</span>.<span style=color:#a6e22e>length</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ip_address</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>ip</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;SUCCESS&#39;</span>
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Send response
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>json</span>(<span style=color:#a6e22e>resources</span>);
</span></span></code></pre></div><p><strong>Key point:</strong> Complete audit trail. The SaaS can&rsquo;t hide access attempts.</p><h2 id=security-threats-and-mitigations>Security Threats and Mitigations<a href=#security-threats-and-mitigations class=hanchor arialabel=Anchor>#</a></h2><h3 id=threat-1-token-theft>Threat 1: Token Theft<a href=#threat-1-token-theft class=hanchor arialabel=Anchor>#</a></h3><p><strong>Scenario:</strong> The SaaS&rsquo;s access token is stolen.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>Attacker has token: &#34;Bearer eyJ0eXAiOiJKV1Qi...&#34;
</span></span><span style=display:flex><span>  → Can call: /api/customers/{id}/orders
</span></span><span style=display:flex><span>  → Can access: Data for that customer
</span></span><span style=display:flex><span>  → Limited by: Token scope (can&#39;t access all customers)
</span></span><span style=display:flex><span>  → Limited by: Token expiry (short-lived)
</span></span></code></pre></div><p><strong>Mitigation:</strong></p><ul><li>Use short-lived tokens (5-15 minutes)</li><li>Implement token binding (IP, device ID)</li><li>Require MFA for new SaaS client registrations</li><li>Monitor for anomalous usage patterns</li><li>Quick token revocation (invalidate cached tokens)</li></ul><h3 id=threat-2-gateway-compromise>Threat 2: Gateway Compromise<a href=#threat-2-gateway-compromise class=hanchor arialabel=Anchor>#</a></h3><p><strong>Scenario:</strong> Your PaaS API gateway is breached.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>Gateway compromised:
</span></span><span style=display:flex><span>  → Attacker has access to all SaaS clients
</span></span><span style=display:flex><span>  → Can fetch all customer data
</span></span><span style=display:flex><span>  → BUT: You control gateway, you can detect/respond
</span></span></code></pre></div><p><strong>Mitigation:</strong></p><ul><li>Monitor the gateway for anomalous patterns</li><li>Implement circuit breakers for suspicious activity</li><li>Use a separate gateway per SaaS client (isolation)</li><li>Regular security audits of gateway code</li><li>Zero trust: Assume gateway could be compromised, validate all requests</li></ul><h3 id=threat-3-saas-side-channel-attacks>Threat 3: SaaS Side-Channel Attacks<a href=#threat-3-saas-side-channel-attacks class=hanchor arialabel=Anchor>#</a></h3><p><strong>Scenario:</strong> The SaaS is modified to include malicious scripts.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>SaaS compromised:
</span></span><span style=display:flex><span>  → Modified JavaScript to send all data to attacker
</span></span><span style=display:flex><span>  → The gateway can&#39;t detect this (requests are valid)
</span></span><span style=display:flex><span>  → Gateway returns data normally
</span></span></code></pre></div><p><strong>Mitigation:</strong></p><ul><li>Validate all SaaS requests (origin, content-type)</li><li>Set CSP headers on gateway responses</li><li>Rate limit per SaaS client</li><li>Monitor the SaaS domain for changes (certificate transparency)</li></ul><h3 id=threat-4-privilege-escalation-via-scopes>Threat 4: Privilege Escalation via Scopes<a href=#threat-4-privilege-escalation-via-scopes class=hanchor arialabel=Anchor>#</a></h3><p><strong>Scenario:</strong> The SaaS requests more scope than authorized.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>SaaS has token: scope=&#34;read:customer_data&#34;
</span></span><span style=display:flex><span>  → Attacker tries: POST /api/customers/{id} (write)
</span></span><span style=display:flex><span>  → The gateway rejects: Insufficient scope
</span></span></code></pre></div><p><strong>Mitigation:</strong></p><ul><li>Implement strict scope validation</li><li>Use granular scopes (read:orders vs read:all)</li><li>Audit scope assignments regularly</li><li>Just-in-time scope elevation (temporary access)</li></ul><h2 id=implementation-patterns>Implementation Patterns<a href=#implementation-patterns class=hanchor arialabel=Anchor>#</a></h2><h3 id=pattern-1-multi-saas-gateway>Pattern 1: Multi-SaaS Gateway<a href=#pattern-1-multi-saas-gateway class=hanchor arialabel=Anchor>#</a></h3><p>One gateway serves multiple SaaS platforms:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>Your Gateway
</span></span><span style=display:flex><span>   ├─→ SaaS Client A (scope: read_a)
</span></span><span style=display:flex><span>   ├─→ SaaS Client B (scope: read_b)
</span></span><span style=display:flex><span>   └─→ SaaS Client C (scope: read_c)
</span></span><span style=display:flex><span>            ↓
</span></span><span style=display:flex><span>Azure Services (with RBAC per client)
</span></span></code></pre></div><p><strong>Benefits:</strong></p><ul><li>Centralized monitoring</li><li>Single codebase</li><li>Easier to maintain</li></ul><p><strong>Risks:</strong></p><ul><li>Blast radius if gateway is compromised</li><li>Harder to isolate issues</li></ul><p><strong>Mitigation:</strong></p><ul><li>Rate limits per client</li><li>Separate RBAC scopes per client</li><li>Gateway deployment per region (availability zones)</li></ul><h3 id=pattern-2-gateway-per-tenant>Pattern 2: Gateway per Tenant<a href=#pattern-2-gateway-per-tenant class=hanchor arialabel=Anchor>#</a></h3><p>Each SaaS client gets a dedicated gateway:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>SaaS Client A → Gateway A → Azure Tenant A
</span></span><span style=display:flex><span>SaaS Client B → Gateway B → Azure Tenant B
</span></span><span style=display:flex><span>SaaS Client C → Gateway C → Azure Tenant C
</span></span></code></pre></div><p><strong>Benefits:</strong></p><ul><li>Maximum isolation</li><li>Per-tenant customization</li><li>Independent scaling</li></ul><p><strong>Risks:</strong></p><ul><li>Infrastructure overhead</li><li>Management complexity</li></ul><p><strong>Mitigation:</strong></p><ul><li>Use templates/IaC for gateway deployment</li><li>Centralized logging across all gateways</li><li>Shared security policies via config</li></ul><h3 id=pattern-3-direct-integration-gateway-skip>Pattern 3: Direct Integration (Gateway Skip)<a href=#pattern-3-direct-integration-gateway-skip class=hanchor arialabel=Anchor>#</a></h3><p>The SaaS integrates directly with Azure services:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>SaaS → Azure Services (Direct)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Pros:
</span></span><span style=display:flex><span>  • Fewer hops (faster)
</span></span><span style=display:flex><span>  • Less infrastructure to manage
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Cons:
</span></span><span style=display:flex><span>  ❌ No single enforcement point
</span></span><span style=display:flex><span>  ❌ Can&#39;t implement SaaS-specific controls
</span></span><span style=display:flex><span>  ❌ Harder to monitor per SaaS usage
</span></span><span style=display:flex><span>  ❌ If one service is compromised, no isolation
</span></span></code></pre></div><p><strong>When to use:</strong></p><ul><li>Simple CRUD with minimal security requirements</li><li>Same team maintains everything</li><li>Fast iteration needed</li></ul><p><strong>When NOT to use:</strong></p><ul><li>High security requirements</li><li>Compliance-driven audits</li><li>Multi-tenant SaaS clients</li><li>Need per-SaaS monitoring</li></ul><h2 id=best-practices-for-secure-implementation>Best Practices for Secure Implementation<a href=#best-practices-for-secure-implementation class=hanchor arialabel=Anchor>#</a></h2><h3 id=1-use-managed-identities>1. Use Managed Identities<a href=#1-use-managed-identities class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// Gateway uses managed identity to access Azure
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>cosmos</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;@azure/cosmos-db&#39;</span>).<span style=color:#a6e22e>CosmosClient</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>endpoint</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>COSMOS_ENDPOINT</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>aadCredentials</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>DefaultAzureCredential</span>()
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p><strong>Grant minimal permissions:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Gateway identity can only read customer data</span>
</span></span><span style=display:flex><span>az role assignment create <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  --assignee-id <span style=color:#66d9ef>$(</span>az identity show --resource-group MyRG --name GatewayIdentity --query principalId -o tsv<span style=color:#66d9ef>)</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  --role <span style=color:#e6db74>&#39;Cosmos DB Built-in Data Contributor&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  --scope /subscriptions/xxx/resourceGroups/xxx/providers/Microsoft.DocumentDB/databaseAccounts/xxx
</span></span></code></pre></div><h3 id=2-implement-token-caching-with-invalidation>2. Implement Token Caching (With Invalidation)<a href=#2-implement-token-caching-with-invalidation class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>tokenCache</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Map</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>validateToken</span>(<span style=color:#a6e22e>token</span>) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Check cache
</span></span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>cached</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tokenCache</span>.<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>token</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>cached</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Validate hasn&#39;t been revoked
</span></span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#66d9ef>await</span> <span style=color:#a6e22e>isTokenRevoked</span>(<span style=color:#a6e22e>token</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cached</span>.<span style=color:#a6e22e>decoded</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>tokenCache</span>.<span style=color:#66d9ef>delete</span>(<span style=color:#a6e22e>token</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Validate with Azure AD
</span></span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>decoded</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>msal</span>.<span style=color:#a6e22e>verify</span>(<span style=color:#a6e22e>token</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>decoded</span>) <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Cache successful validation
</span></span></span><span style=display:flex><span>  <span style=color:#a6e22e>tokenCache</span>.<span style=color:#a6e22e>set</span>(<span style=color:#a6e22e>token</span>, { <span style=color:#a6e22e>decoded</span>, <span style=color:#a6e22e>timestamp</span><span style=color:#f92672>:</span> Date.<span style=color:#a6e22e>now</span>() }, <span style=color:#a6e22e>ttl</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>300000</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>decoded</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>revokeToken</span>(<span style=color:#a6e22e>token</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>tokenCache</span>.<span style=color:#66d9ef>delete</span>(<span style=color:#a6e22e>token</span>);
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Notify all gateway instances via cache/Redis/pub-sub
</span></span></span><span style=display:flex><span>  <span style=color:#a6e22e>publishTokenRevocation</span>(<span style=color:#a6e22e>token</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=3-implement-comprehensive-logging>3. Implement Comprehensive Logging<a href=#3-implement-comprehensive-logging class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// Structured logging for security analytics
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>logSecurityEvent</span>(<span style=color:#a6e22e>event</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>analytics</span>.<span style=color:#a6e22e>trackEvent</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>timestamp</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> Date(),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>event_type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>type</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>saas_client_id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>clientId</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>customer_id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>customerId</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ip_address</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>ip</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>user_agent</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>userAgent</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request_path</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>path</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>status_code</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>statusCode</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>latency_ms</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>duration</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>scope_requested</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>scope</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>auth_method</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>authMethod</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>risk_score</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>calculateRiskScore</span>(<span style=color:#a6e22e>event</span>)
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Example events
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>await</span> <span style=color:#a6e22e>logSecurityEvent</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;AUTHENTICATION_SUCCESS&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>clientId</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;saas-client-123&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>customer_id</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;cust-456&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ip</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;10.0.1.50&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>statusCode</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>200</span>
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h3 id=4-rate-limiting-strategy>4. Rate Limiting Strategy<a href=#4-rate-limiting-strategy class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// Per-client rate limits
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>rateLimits</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;saas-client-123&#39;</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>requests</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>100</span>, window<span style=color:#f92672>:</span> <span style=color:#ae81ff>60000</span> },  <span style=color:#75715e>// 100 req / minute
</span></span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;saas-client-456&#39;</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>requests</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>10</span>, window<span style=color:#f92672>:</span> <span style=color:#ae81ff>60000</span> }    <span style=color:#75715e>// 10 req / minute (stricter)
</span></span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>checkRateLimit</span>(<span style=color:#a6e22e>clientId</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>limit</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>rateLimits</span>[<span style=color:#a6e22e>clientId</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>now</span> <span style=color:#f92672>=</span> Date.<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Sliding window
</span></span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>recentRequests</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>lrange</span>(<span style=color:#e6db74>`rate:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>clientId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, <span style=color:#ae81ff>0</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>windowStart</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>now</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>limit</span>.window;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Remove expired entries
</span></span></span><span style=display:flex><span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>ltrim</span>(<span style=color:#e6db74>`rate:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>clientId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>llen</span>(<span style=color:#e6db74>`rate:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>clientId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>recentRequests</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>limit</span>.<span style=color:#a6e22e>requests</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>RateLimitError</span>(<span style=color:#e6db74>`Rate limit exceeded: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>limit</span>.<span style=color:#a6e22e>requests</span><span style=color:#e6db74>}</span><span style=color:#e6db74> requests / </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>limit</span>.window <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000</span><span style=color:#e6db74>}</span><span style=color:#e6db74>s`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Add current request
</span></span></span><span style=display:flex><span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>lpush</span>(<span style=color:#e6db74>`rate:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>clientId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, <span style=color:#a6e22e>now</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>expire</span>(<span style=color:#e6db74>`rate:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>clientId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, <span style=color:#a6e22e>limit</span>.window <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=5-input-validation-and-sanitization>5. Input Validation and Sanitization<a href=#5-input-validation-and-sanitization class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// Validate before passing to Azure services
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>validateCustomerRequest</span>(<span style=color:#a6e22e>params</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>errors</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Validate customer ID format
</span></span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#e6db74>/^[a-f0-9]{32}$/</span>.<span style=color:#a6e22e>test</span>(<span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>customerId</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>push</span>(<span style=color:#e6db74>&#39;Invalid customer ID format&#39;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Validate parameters
</span></span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>limit</span> <span style=color:#f92672>&amp;&amp;</span> (<span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>limit</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>limit</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>100</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>push</span>(<span style=color:#e6db74>&#39;Limit must be between 1 and 100&#39;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Sanitize input (prevent injection)
</span></span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>sanitized</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>customerId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>customerId</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>/[^a-f0-9]/g</span>, <span style=color:#e6db74>&#39;&#39;</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>limit</span><span style=color:#f92672>:</span> Math.<span style=color:#a6e22e>min</span>(<span style=color:#ae81ff>100</span>, parseInt(<span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>limit</span>) <span style=color:#f92672>||</span> <span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>offset</span><span style=color:#f92672>:</span> Math.<span style=color:#a6e22e>max</span>(<span style=color:#ae81ff>0</span>, parseInt(<span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>offset</span>) <span style=color:#f92672>||</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ValidationError</span>(<span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#39;, &#39;</span>));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sanitized</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=6-circuit-breaker-pattern>6. Circuit Breaker Pattern<a href=#6-circuit-breaker-pattern class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// Prevent cascading failures
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>CircuitBreaker</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;opossum-circuit-breaker&#39;</span>).<span style=color:#a6e22e>CircuitBreaker</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>breaker</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>CircuitBreaker</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>timeout</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>30000</span>,  <span style=color:#75715e>// 30 second timeout
</span></span></span><span style=display:flex><span>  <span style=color:#a6e22e>errorThresholdPercentage</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>50</span>,  <span style=color:#75715e>// Open if 50% fail
</span></span></span><span style=display:flex><span>  <span style=color:#a6e22e>resetTimeout</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>60000</span>  <span style=color:#75715e>// Try again after 60 seconds
</span></span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>fetchCustomerData</span>(<span style=color:#a6e22e>customerId</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>breaker</span>.<span style=color:#a6e22e>fire</span>(
</span></span><span style=display:flex><span>    () =&gt; <span style=color:#a6e22e>cosmos</span>.<span style=color:#a6e22e>fetchCustomer</span>(<span style=color:#a6e22e>customerId</span>),
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>error</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Fallback: use cache or return error
</span></span></span><span style=display:flex><span>      <span style=color:#a6e22e>logSecurityEvent</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;CIRCUIT_BREAKER_OPEN&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span>
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>getCachedData</span>(<span style=color:#a6e22e>customerId</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=monitoring-and-observability>Monitoring and Observability<a href=#monitoring-and-observability class=hanchor arialabel=Anchor>#</a></h2><h3 id=key-metrics-to-track>Key Metrics to Track<a href=#key-metrics-to-track class=hanchor arialabel=Anchor>#</a></h3><table><thead><tr><th>Metric</th><th>What It Shows</th><th>Why It Matters</th></tr></thead><tbody><tr><td><strong>Request rate</strong></td><td>Requests/second per SaaS client</td><td>Detect abuse, DDoS</td></tr><tr><td><strong>Error rate</strong></td><td>Failed requests percentage</td><td>Detect attacks, misconfiguration</td></tr><tr><td><strong>Latency p95/p99</strong></td><td>Response time at 95th/99th percentile</td><td>Detect degradation</td></tr><tr><td><strong>Scope violations</strong></td><td>Unauthorized scope access attempts</td><td>Detect token misuse</td></tr><tr><td><strong>IP anomalies</strong></td><td>Unusual geographic or time patterns</td><td>Detect stolen tokens</td></tr><tr><td><strong>Data access volume</strong></td><td>MB/GB returned per client</td><td>Detect exfiltration</td></tr><tr><td><strong>Gateway health</strong></td><td>Uptime, error rates, circuit status</td><td>Detect infrastructure issues</td></tr></tbody></table><h3 id=alerting-strategy>Alerting Strategy<a href=#alerting-strategy class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// Set up alerts
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>setupAlerts</span>() {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// High error rate
</span></span></span><span style=display:flex><span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>alertRule</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;High Error Rate&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>condition</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;error_rate &gt; 10%&#39;</span>,
</span></span><span style=display:flex><span>    window<span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;5m&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>severity</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;WARNING&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>action</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;notify_security_team&#39;</span>
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Suspicious IP access
</span></span></span><span style=display:flex><span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>alertRule</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Unusual Geographic Access&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>condition</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;new_country_count &gt; 3&#39;</span>,
</span></span><span style=display:flex><span>    window<span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;10m&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>severity</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;CRITICAL&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>action</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;block_ip&#39;</span>
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Data exfiltration detection
</span></span></span><span style=display:flex><span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>alertRule</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;High Data Volume&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>condition</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;mb_returned &gt; 1000&#39;</span>,
</span></span><span style=display:flex><span>    window<span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;1h&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>severity</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;CRITICAL&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>action</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;revoke_token&#39;</span>
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=common-pitfalls-to-avoid>Common Pitfalls to Avoid<a href=#common-pitfalls-to-avoid class=hanchor arialabel=Anchor>#</a></h2><h3 id=pitfall-1-long-lived-tokens>Pitfall 1: Long-Lived Tokens<a href=#pitfall-1-long-lived-tokens class=hanchor arialabel=Anchor>#</a></h3><p><strong>Bad:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;access_token&#34;</span>: <span style=color:#e6db74>&#34;eyJ...&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;expires_in&#34;</span>: <span style=color:#ae81ff>86400</span>  <span style=color:#75715e>// 24 hours!
</span></span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Good:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;access_token&#34;</span>: <span style=color:#e6db74>&#34;eyJ...&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;expires_in&#34;</span>: <span style=color:#ae81ff>900</span>  <span style=color:#75715e>// 15 minutes
</span></span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=pitfall-2-over-scoped-tokens>Pitfall 2: Over-Scoped Tokens<a href=#pitfall-2-over-scoped-tokens class=hanchor arialabel=Anchor>#</a></h3><p><strong>Bad:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// The SaaS requests full access token
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>getGatewayToken</span>(<span style=color:#e6db74>&#39;full_access&#39;</span>);
</span></span></code></pre></div><p><strong>Good:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// The SaaS requests minimal scope
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>getGatewayToken</span>(<span style=color:#e6db74>&#39;read_customer_orders&#39;</span>);
</span></span></code></pre></div><h3 id=pitfall-3-skipping-input-validation>Pitfall 3: Skipping Input Validation<a href=#pitfall-3-skipping-input-validation class=hanchor arialabel=Anchor>#</a></h3><p><strong>Bad:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// Pass-through to Azure services
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>cosmos</span>.<span style=color:#a6e22e>query</span>(<span style=color:#e6db74>`SELECT * FROM c WHERE c.id = </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>customerId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span></code></pre></div><p><strong>Good:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// Validate and sanitize
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>sanitized</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>validateCustomerId</span>(<span style=color:#a6e22e>customerId</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>cosmos</span>.<span style=color:#a6e22e>query</span>(<span style=color:#e6db74>&#39;SELECT * FROM c WHERE c.id = @id&#39;</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>parameters</span><span style=color:#f92672>:</span> [{ <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;@id&#39;</span>, <span style=color:#a6e22e>value</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>sanitized</span> }]
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h3 id=pitfall-4-no-per-client-monitoring>Pitfall 4: No Per-Client Monitoring<a href=#pitfall-4-no-per-client-monitoring class=hanchor arialabel=Anchor>#</a></h3><p><strong>Bad:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// Aggregated monitoring
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Total requests: 10000&#39;</span>);
</span></span></code></pre></div><p><strong>Good:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// Per-client monitoring
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;SaaS Client A: 5000 requests&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;SaaS Client B: 3000 requests&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;SaaS Client C: 2000 requests&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;SaaS Client D: 0 requests (suspicious!)&#39;</span>);
</span></span></code></pre></div><h3 id=pitfall-5-hard-coded-secrets>Pitfall 5: Hard-Coded Secrets<a href=#pitfall-5-hard-coded-secrets class=hanchor arialabel=Anchor>#</a></h3><p><strong>Bad:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>cosmos</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>CosmosClient</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>endpoint</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>COSMOS_ENDPOINT</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>key</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;C2y6yZ...&#39;</span>  <span style=color:#75715e>// Hard-coded!
</span></span></span><span style=display:flex><span>});
</span></span></code></pre></div><p><strong>Good:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>cosmos</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>CosmosClient</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>endpoint</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>COSMOS_ENDPOINT</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>aadCredentials</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>DefaultAzureCredential</span>()  <span style=color:#75715e>// Managed identity
</span></span></span><span style=display:flex><span>});
</span></span></code></pre></div><h2 id=performance-considerations>Performance Considerations<a href=#performance-considerations class=hanchor arialabel=Anchor>#</a></h2><h3 id=gateway-as-bottleneck>Gateway as Bottleneck?<a href=#gateway-as-bottleneck class=hanchor arialabel=Anchor>#</a></h3><p><strong>The gateway adds latency. Is it worth it?</strong></p><table><thead><tr><th>Operation</th><th>Direct Access</th><th>Through Gateway</th><th>Overhead</th></tr></thead><tbody><tr><td><strong>Token validation</strong></td><td>N/A</td><td>~5ms</td><td>Low</td></tr><tr><td><strong>Rate limit check</strong></td><td>N/A</td><td>~10ms</td><td>Low</td></tr><tr><td><strong>Logging</strong></td><td>N/A</td><td>~15ms</td><td>Low</td></tr><tr><td><strong>Azure fetch</strong></td><td>~50ms</td><td>~55ms</td><td>Low</td></tr><tr><td><strong>Total</strong></td><td>~50ms</td><td>~85ms</td><td>Acceptable</td></tr></tbody></table><p><strong>Optimization strategies:</strong></p><ul><li>Cache token validations (5 min TTL)</li><li>Use in-memory rate limit tracking (Redis, not DB)</li><li>Async logging (don&rsquo;t block on logging)</li><li>Regional gateway deployment (reduce network hops)</li></ul><h3 id=scaling-your-gateway>Scaling Your Gateway<a href=#scaling-your-gateway class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>API Gateway Service
</span></span><span style=display:flex><span>   Azure App Service / Azure Functions
</span></span><span style=display:flex><span>      Scale out: 10-100 instances
</span></span><span style=display:flex><span>      Scale in: CPU-based / schedule-based
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Azure Services (Data Layer)
</span></span><span style=display:flex><span>   Cosmos DB / SQL / Storage
</span></span><span style=display:flex><span>      Scales independently
</span></span></code></pre></div><p><strong>Independent scaling:</strong> The gateway scales separately from the data services. Load spikes in the SaaS don&rsquo;t crash your databases.</p><h2 id=conclusion-why-this-pattern-works>Conclusion: Why This Pattern Works<a href=#conclusion-why-this-pattern-works class=hanchor arialabel=Anchor>#</a></h2><table><thead><tr><th>Aspect</th><th>With Your Gateway</th><th>Without Gateway</th></tr></thead><tbody><tr><td><strong>Trust boundary</strong></td><td>✅ Data never leaves your tenant</td><td>❌ The SaaS stores data</td></tr><tr><td><strong>Security control</strong></td><td>✅ You control all enforcement</td><td>❌ The SaaS controls access</td></tr><tr><td><strong>Compliance</strong></td><td>✅ You prove data handling</td><td>❌ The SaaS&rsquo;s compliance, not yours</td></tr><tr><td><strong>Monitoring</strong></td><td>✅ Per-SaaS visibility</td><td>❌ No SaaS-level visibility</td></tr><tr><td><strong>Vendor lock-in</strong></td><td>✅ Can switch SaaS easily</td><td>❌ Locked into SaaS</td></tr><tr><td><strong>Isolation</strong></td><td>✅ Gateway isolates SaaS clients</td><td>❌ All clients share access</td></tr></tbody></table><p><strong>The bottom line:</strong> Your PaaS API gateway creates a security-by-design architecture. Data sovereignty, trust boundaries, and proper monitoring give you a defensible security posture.</p><p>This isn&rsquo;t about hiding features or creating separation through obscurity. It&rsquo;s about <strong>enforcing security at every layer</strong> - from the SaaS request to the Azure service response.</p><p>The SaaS gets a clean UI and fast data. You get control, compliance, and peace of mind.</p><hr><p><em>This guide is based on real-world SaaS integrations with Azure services. Always adapt patterns to your specific requirements and threat model.</em></p></div></div><div class=related-posts style="margin-top:3rem;padding-top:2rem;border-top:1px solid #333"><h3>Related Posts</h3><ul style=list-style:none;padding:0><li style=margin-bottom:1rem><a href=https://gazsecops.github.io/posts/azure-logic-apps-security-guide/>Azure Logic Apps Security: A Guide for Cyber Security Consultants</a>
<span style=color:#999;font-size:.9rem>- 6 Feb 2026</span><div style=font-size:.85rem;color:#666;margin-top:.25rem><span style=margin-right:.5rem>#azure</span>
<span style=margin-right:.5rem>#security</span>
<span style=margin-right:.5rem>#serverless</span>
<span style=margin-right:.5rem>#logic-apps</span>
<span style=margin-right:.5rem>#cloud-security</span></div></li><li style=margin-bottom:1rem><a href=https://gazsecops.github.io/posts/threat-analysis-practical-guide/>Threat Analysis: What Actually Works</a>
<span style=color:#999;font-size:.9rem>- 8 Feb 2026</span><div style=font-size:.85rem;color:#666;margin-top:.25rem><span style=margin-right:.5rem>#security</span>
<span style=margin-right:.5rem>#threat-analysis</span>
<span style=margin-right:.5rem>#risk-management</span>
<span style=margin-right:.5rem>#defense</span>
<span style=margin-right:.5rem>#methodology</span></div></li><li style=margin-bottom:1rem><a href=https://gazsecops.github.io/posts/workload-identity-beyond-api-keys/>Workload Identity: Giving Your Services an Identity Without the Secret Sprawl</a>
<span style=color:#999;font-size:.9rem>- 8 Feb 2026</span><div style=font-size:.85rem;color:#666;margin-top:.25rem><span style=margin-right:.5rem>#security</span>
<span style=margin-right:.5rem>#identity</span>
<span style=margin-right:.5rem>#cloud</span>
<span style=margin-right:.5rem>#kubernetes</span>
<span style=margin-right:.5rem>#spiffe</span>
<span style=margin-right:.5rem>#operations</span></div></li><li style=margin-bottom:1rem><a href=https://gazsecops.github.io/posts/oauth2-obo-flow-complete-guide/>OAuth2 On-Behalf-Of Flow: A Complete Guide for Microservices</a>
<span style=color:#999;font-size:.9rem>- 4 Feb 2026</span><div style=font-size:.85rem;color:#666;margin-top:.25rem><span style=margin-right:.5rem>#oauth2</span>
<span style=margin-right:.5rem>#security</span>
<span style=margin-right:.5rem>#microservices</span>
<span style=margin-right:.5rem>#authentication</span>
<span style=margin-right:.5rem>#authorization</span></div></li><li style=margin-bottom:1rem><a href=https://gazsecops.github.io/posts/security-as-code-beyond-scanning/>Beyond Scanning: What Security as Code Really Means</a>
<span style=color:#999;font-size:.9rem>- 22 Nov 2025</span><div style=font-size:.85rem;color:#666;margin-top:.25rem><span style=margin-right:.5rem>#security</span>
<span style=margin-right:.5rem>#devsecops</span>
<span style=margin-right:.5rem>#automation</span>
<span style=margin-right:.5rem>#culture</span>
<span style=margin-right:.5rem>#operations</span></div></li></ul></div><div class=pagination><div class=pagination__title><span class=pagination__title-h></span><hr></div><div class=pagination__buttons><a href=https://gazsecops.github.io/posts/threat-analysis-practical-guide/ class="button inline next">[<span class=button__text>Threat Analysis: What Actually Works</span>] ></a></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2026</span></div><div class=build-info><span class=build-commit>e733073</span><span class=build-date>2026-02-12 12:33 UTC</span></div></div></footer></div></body></html>