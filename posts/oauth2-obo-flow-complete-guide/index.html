<!doctype html><html lang=en><head><title>OAuth2 On-Behalf-Of Flow: A Complete Guide for Microservices :: Gareth's Engineering Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content=" Engineer: Service A already has the user&rsquo;s access token. Why don&rsquo;t we just forward it to Service B?
Sysadmin: Because it isn&rsquo;t for Service B. Wrong audience, wrong scopes, and you just turned one compromise into &ldquo;own the lot&rdquo;.
Engineer: So what&rsquo;s the right way?
Sysadmin: Exchange it. Get a token meant for Service B, on behalf of the user. Validate it at Service B. Every time.
The On-Behalf-Of (OBO) flow is one of the lesser-understood OAuth2 grant types, yet it&rsquo;s critical for secure microservice architectures.
OBO is how you keep user identity across service boundaries without turning your API gateway into a skeleton key. It matters because it preserves user identity through a service chain, enables proper audit trails, and limits the damage when a single service gets popped.
If you&rsquo;re building microservices that need to maintain user context across service boundaries, this covers when to use OBO versus client credentials, security considerations, and practical implementation patterns.
"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://gazsecops.github.io/posts/oauth2-obo-flow-complete-guide/><link rel=stylesheet href=https://gazsecops.github.io/css/extended.min.c658c723e006469d82f697e19c5338967fad12c57650bdd915bacf9cfbe2cc38.css><link rel=stylesheet href=https://gazsecops.github.io/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css><link rel=stylesheet href=https://gazsecops.github.io/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css><link rel=stylesheet href=https://gazsecops.github.io/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css><link rel=stylesheet href=https://gazsecops.github.io/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css><link rel=stylesheet href=https://gazsecops.github.io/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css><link rel=stylesheet href=https://gazsecops.github.io/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css><link rel=stylesheet href=https://gazsecops.github.io/css/main.min.36833afd348409fc6c3d09d0897c5833d9d5bf1ff31f5e60ea3ee42ce2b1268c.css><link rel=stylesheet href=https://gazsecops.github.io/css/menu.min.3c17467ebeb3d38663dce68f71f519901124fa5cbb4519b2fb0667a21e9aca39.css><link rel=stylesheet href=https://gazsecops.github.io/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css><link rel=stylesheet href=https://gazsecops.github.io/css/post.min.e6dddd258e64c83e05cec0cd49c05216742d42fc8ecbfbe6b67083412b609bd3.css><link rel=stylesheet href=https://gazsecops.github.io/css/syntax.min.a0773cce9310cb6d8ed23e50f005448facf29a53001b57e038828daa466b25c0.css><link rel=stylesheet href=https://gazsecops.github.io/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css><link rel=stylesheet href=https://gazsecops.github.io/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css><link rel="shortcut icon" href=https://gazsecops.github.io/favicon.png><link rel=apple-touch-icon href=https://gazsecops.github.io/apple-touch-icon.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="OAuth2 On-Behalf-Of Flow: A Complete Guide for Microservices"><meta property="og:description" content=" Engineer: Service A already has the user&rsquo;s access token. Why don&rsquo;t we just forward it to Service B?
Sysadmin: Because it isn&rsquo;t for Service B. Wrong audience, wrong scopes, and you just turned one compromise into &ldquo;own the lot&rdquo;.
Engineer: So what&rsquo;s the right way?
Sysadmin: Exchange it. Get a token meant for Service B, on behalf of the user. Validate it at Service B. Every time.
The On-Behalf-Of (OBO) flow is one of the lesser-understood OAuth2 grant types, yet it&rsquo;s critical for secure microservice architectures.
OBO is how you keep user identity across service boundaries without turning your API gateway into a skeleton key. It matters because it preserves user identity through a service chain, enables proper audit trails, and limits the damage when a single service gets popped.
If you&rsquo;re building microservices that need to maintain user context across service boundaries, this covers when to use OBO versus client credentials, security considerations, and practical implementation patterns.
"><meta property="og:url" content="https://gazsecops.github.io/posts/oauth2-obo-flow-complete-guide/"><meta property="og:site_name" content="Gareth's Engineering Blog"><meta property="og:image" content="https://gazsecops.github.io/og-image.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2026-02-04 12:28:00 +0000 UTC"></head><body><div class="container center"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>gareth@blog:~$</div></a></div><div class=header__search><input type=text id=header-search placeholder="Quick search..." style="padding:5px 10px;background:#222;color:#eee;border:1px solid #444;border-radius:3px;font-size:14px;width:200px"></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/topics/>Topics</a></li><li><a href=/posts/>All</a></li><li><a href=/series/>Series</a></li><li><a href=/tags/>Tags</a></li><li><a href=/archive/>Archive</a></li><li><a href=/search/>Search</a></li><li><a href=/about/>About</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/topics/>Topics</a></li><li><a href=/posts/>All</a></li><li><a href=/series/>Series</a></li><li><a href=/tags/>Tags</a></li><li><a href=/archive/>Archive</a></li><li><a href=/search/>Search</a></li><li><a href=/about/>About</a></li></ul></nav></header><script>(function(){const e=document.getElementById("header-search");if(!e)return;e.addEventListener("keydown",function(e){if(e.key==="Enter"){const e=this.value.trim();e&&(window.location.href="/search?q="+encodeURIComponent(e))}}),document.addEventListener("keydown",function(t){t.key==="/"&&!["INPUT","TEXTAREA"].includes(t.target.tagName)&&(t.preventDefault(),e.focus()),t.key==="Escape"&&t.target===e&&e.blur()})})()</script><style>.header__inner{display:flex;align-items:center;gap:20px}.header__search{flex:none}#header-search::placeholder{color:#666;font-style:italic}#header-search:focus{outline:none;border-color:#888}@media(max-width:684px){.header__search{display:none}}</style><div class=content><article class=post><h1 class=post-title><a href=https://gazsecops.github.io/posts/oauth2-obo-flow-complete-guide/>OAuth2 On-Behalf-Of Flow: A Complete Guide for Microservices</a></h1><div class=post-meta><time class=post-date>2026-02-04</time><span class=post-author>Gareth</span><span class=post-reading-time>19 min read (3874 words)</span></div><span class=post-tags>#<a href=https://gazsecops.github.io/tags/oauth2/>oauth2</a>&nbsp;
#<a href=https://gazsecops.github.io/tags/security/>security</a>&nbsp;
#<a href=https://gazsecops.github.io/tags/microservices/>microservices</a>&nbsp;
#<a href=https://gazsecops.github.io/tags/authentication/>authentication</a>&nbsp;
#<a href=https://gazsecops.github.io/tags/authorization/>authorization</a>&nbsp;</span><div class=table-of-contents><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#what-is-the-obo-flow>What is the OBO Flow?</a></li><li><a href=#when-should-you-use-obo-flow>When Should You Use OBO Flow?</a><ul><li><a href=#decision-framework>Decision Framework</a></li><li><a href=#use-obo-flow-when>Use OBO Flow When</a></li><li><a href=#use-client-credentials-when>Use Client Credentials When</a></li><li><a href=#trade-offs>Trade-offs</a></li><li><a href=#common-scenarios>Common Scenarios</a></li><li><a href=#when-simpler-approaches-may-be-appropriate>When Simpler Approaches May Be Appropriate</a></li></ul></li><li><a href=#the-obo-flow-step-by-step>The OBO Flow: Step by Step</a><ul><li><a href=#step-1-user-authenticates-standard-oauth2>Step 1: User Authenticates (Standard OAuth2)</a></li><li><a href=#step-2-service-a-receives-the-token>Step 2: Service A Receives the Token</a></li><li><a href=#step-3-service-a-needs-to-call-service-b-obo-begins>Step 3: Service A Needs to Call Service B (OBO Begins!)</a></li><li><a href=#step-4-service-a-calls-service-b>Step 4: Service A Calls Service B</a></li></ul></li><li><a href=#security-considerations>Security Considerations</a><ul><li><a href=#1-token-validation-at-every-service>1. <strong>Token Validation at Every Service</strong></a></li><li><a href=#2-scope-validation>2. <strong>Scope Validation</strong></a></li><li><a href=#3-client-credential-rotation>3. <strong>Client Credential Rotation</strong></a></li><li><a href=#4-https-everywhere>4. <strong>HTTPS Everywhere</strong></a></li><li><a href=#5-token-caching>5. <strong>Token Caching</strong></a></li></ul></li><li><a href=#threat-model-what-obo-flow-protects-against-and-what-it-doesnt>Threat Model: What OBO Flow Protects Against (And What It Doesn&rsquo;t)</a><ul><li><a href=#threats-obo-flow-mitigates>Threats OBO Flow Mitigates</a></li><li><a href=#threats-obo-flow-does-not-protect-against>Threats OBO Flow Does NOT Protect Against</a></li><li><a href=#real-world-scenario-compromised-api-gateway>Real-World Scenario: Compromised API Gateway</a></li><li><a href=#limitations-and-caveats>Limitations and Caveats</a></li><li><a href=#defense-in-depth>Defense in Depth</a></li></ul></li><li><a href=#common-pitfalls>Common Pitfalls</a><ul><li><a href=#pitfall-1-forwarding-the-original-token>Pitfall 1: Forwarding the Original Token</a></li><li><a href=#pitfall-2-storing-user-credentials>Pitfall 2: Storing User Credentials</a></li><li><a href=#pitfall-3-ignoring-token-expiry>Pitfall 3: Ignoring Token Expiry</a></li><li><a href=#pitfall-4-missing-audience-aud-claim>Pitfall 4: Missing Audience (aud) Claim</a></li></ul></li><li><a href=#implementation-examples>Implementation Examples</a><ul><li><a href=#azure-ad-microsoft-entra-id>Azure AD (Microsoft Entra ID)</a></li><li><a href=#auth0>Auth0</a></li><li><a href=#keycloak>Keycloak</a></li></ul></li><li><a href=#alternative-token-introspection>Alternative: Token Introspection</a></li><li><a href=#performance-optimisations>Performance Optimisations</a><ul><li><a href=#1-token-exchange-caching>1. <strong>Token Exchange Caching</strong></a></li><li><a href=#2-asynchronous-token-refresh>2. <strong>Asynchronous Token Refresh</strong></a></li><li><a href=#3-connection-pooling>3. <strong>Connection Pooling</strong></a></li></ul></li><li><a href=#data-caching-security-vs-performance-trade-offs>Data Caching: Security vs Performance Trade-Offs</a><ul><li><a href=#real-time-fetching-no-caching>Real-Time Fetching (No Caching)</a></li><li><a href=#caching-on-platform>Caching on Platform</a></li><li><a href=#decision-framework-1>Decision Framework</a></li><li><a href=#hybrid-approach-often-best>Hybrid Approach (Often Best)</a></li><li><a href=#caching-strategies-for-sensitive-data>Caching Strategies for Sensitive Data</a></li><li><a href=#real-world-example-user-dashboard>Real-World Example: User Dashboard</a></li><li><a href=#cache-key-design>Cache Key Design</a></li><li><a href=#monitoring-cache-security>Monitoring Cache Security</a></li><li><a href=#the-bottom-line>The Bottom Line</a></li></ul></li><li><a href=#monitoring-and-observability>Monitoring and Observability</a><ul><li><a href=#key-metrics-to-track>Key Metrics to Track</a></li><li><a href=#prometheus-alert-rules-examples>Prometheus Alert Rules (Examples)</a></li><li><a href=#logging>Logging</a></li><li><a href=#distributed-tracing>Distributed Tracing</a></li></ul></li><li><a href=#production-checklist>Production Checklist</a></li><li><a href=#further-reading>Further Reading</a><ul><li><a href=#oauth2-standards>OAuth2 Standards</a></li><li><a href=#idp-specific-documentation>IdP-Specific Documentation</a></li><li><a href=#libraries-and-tools>Libraries and Tools</a></li><li><a href=#best-practices>Best Practices</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div><div class=post-content><div><div class=dialogue><p><span class="speaker speaker-engineer">Engineer:</span> Service A already has the user&rsquo;s access token. Why don&rsquo;t we just forward it to Service B?</p><p><span class="speaker speaker-sysadmin">Sysadmin:</span> Because it isn&rsquo;t for Service B. Wrong audience, wrong scopes, and you just turned one compromise into &ldquo;own the lot&rdquo;.</p><p><span class="speaker speaker-engineer">Engineer:</span> So what&rsquo;s the right way?</p><p><span class="speaker speaker-sysadmin">Sysadmin:</span> Exchange it. Get a token meant for Service B, on behalf of the user. Validate it at Service B. Every time.</p></div><p>The On-Behalf-Of (OBO) flow is one of the lesser-understood OAuth2 grant types, yet it&rsquo;s critical for secure microservice architectures.</p><aside class=pullquote>OBO is how you keep user identity across service boundaries without turning your API gateway into a skeleton key.</aside><p>It matters because it preserves user identity through a service chain, enables proper audit trails, and limits the damage when a single service gets popped.</p><p>If you&rsquo;re building microservices that need to maintain user context across service boundaries, this covers when to use OBO versus client credentials, security considerations, and practical implementation patterns.</p><h2 id=what-is-the-obo-flow>What is the OBO Flow?<a href=#what-is-the-obo-flow class=hanchor arialabel=Anchor>#</a></h2><p>The OAuth2 On-Behalf-Of flow allows a service that&rsquo;s already received an access token from a user to obtain another access token for a different service on that user&rsquo;s behalf. The key insight: the user authenticates once, and that authentication flows through your entire system via token exchanges.</p><p>This matters because it preserves the user&rsquo;s identity throughout your service mesh, enables proper audit trails, and limits the damage if any single service is compromised.</p><h2 id=when-should-you-use-obo-flow>When Should You Use OBO Flow?<a href=#when-should-you-use-obo-flow class=hanchor arialabel=Anchor>#</a></h2><p>The key distinction between OBO flow and other OAuth2 flows is whether you have a <strong>user context</strong>. Here&rsquo;s a structured approach to help you decide.</p><h3 id=decision-framework>Decision Framework<a href=#decision-framework class=hanchor arialabel=Anchor>#</a></h3><table><thead><tr><th>Question</th><th>Your Answer</th><th>Recommended Flow</th></tr></thead><tbody><tr><td><strong>Is there a user involved?</strong></td><td>Yes →</td><td>OBO flow (delegated access)</td></tr><tr><td></td><td>No →</td><td>Client credentials (machine-to-machine)</td></tr><tr><td><strong>Do services need to know WHO made the request?</strong></td><td>Yes →</td><td>OBO flow</td></tr><tr><td></td><td>No →</td><td>Client credentials</td></tr><tr><td><strong>Do different services need different scopes/permissions?</strong></td><td>Yes →</td><td>OBO flow</td></tr><tr><td></td><td>No →</td><td>Client credentials or shared token</td></tr><tr><td><strong>If API Gateway is compromised, should damage be limited?</strong></td><td>Yes →</td><td>OBO flow + per-service tokens</td></tr><tr><td></td><td>Not critical →</td><td>Simpler approaches may suffice</td></tr></tbody></table><h3 id=use-obo-flow-when>Use OBO Flow When<a href=#use-obo-flow-when class=hanchor arialabel=Anchor>#</a></h3><p>You have a <strong>user context</strong> and need delegated access:</p><ul><li><strong>Service chain with user identity</strong> - API Gateway calls User Service on behalf of <code>alice@example.com</code></li><li><strong>Per-service authorization</strong> - User Service needs <code>user.read</code>, Order Service needs <code>order.create</code></li><li><strong>Zero trust architecture</strong> - Every service independently verifies the user&rsquo;s identity</li><li><strong>Containment requirement</strong> - If API Gateway is compromised, attacker can&rsquo;t access everything</li></ul><h3 id=use-client-credentials-when>Use Client Credentials When<a href=#use-client-credentials-when class=hanchor arialabel=Anchor>#</a></h3><p>You have <strong>no user context</strong> (pure machine-to-machine):</p><ul><li><strong>Background jobs</strong> - Cron task calling an API to generate reports</li><li><strong>Service health checks</strong> - Monitoring service checking status of other services</li><li><strong>Internal automation</strong> - CI/CD pipeline calling deployment APIs</li><li><strong>Non-user-initiated operations</strong> - Service A calling Service B for internal maintenance</li></ul><h3 id=trade-offs>Trade-offs<a href=#trade-offs class=hanchor arialabel=Anchor>#</a></h3><table><thead><tr><th>Approach</th><th>Pros</th><th>Cons</th></tr></thead><tbody><tr><td><strong>OBO Flow</strong></td><td>Strong security, least privilege, contained compromise</td><td>More complex, more IdP load, more tokens to manage</td></tr><tr><td><strong>Client Credentials</strong></td><td>Simple, low complexity, well-understood</td><td>No user context, less granular control</td></tr><tr><td><strong>Shared Tokens</strong></td><td>Easiest to implement</td><td>Compromise = full system access, no containment</td></tr></tbody></table><h3 id=common-scenarios>Common Scenarios<a href=#common-scenarios class=hanchor arialabel=Anchor>#</a></h3><p><strong>Scenario 1: API Gateway → User Service (User authenticated)</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>User → API Gateway → User Service
</span></span></code></pre></div><p>✅ <strong>Use OBO flow</strong> - User is making the request. User Service needs to know WHO it&rsquo;s acting on behalf of.</p><p><strong>Scenario 2: API Gateway → Analytics Service (Internal aggregation)</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>User → API Gateway → Analytics Service
</span></span></code></pre></div><p>⚠️ <strong>Consider context</strong> - If analytics service only needs to know &ldquo;a user made a request&rdquo; (not WHO), client credentials may suffice. If it needs user-specific attribution, OBO flow.</p><p><strong>Scenario 3: Cron Job → User Service (No user context)</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>Cron Job → User Service (purge inactive accounts)
</span></span></code></pre></div><p>✅ <strong>Use client credentials</strong> - No user is involved. The cron job is acting on its own behalf.</p><p><strong>Scenario 4: API Gateway → Order Service → Payment Service (User checkout)</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>User → API Gateway → Order Service → Payment Service
</span></span></code></pre></div><p>✅ <strong>Use OBO flow</strong> - User is making a purchase. Each service needs to know who&rsquo;s placing the order and processing payment.</p><h3 id=when-simpler-approaches-may-be-appropriate>When Simpler Approaches May Be Appropriate<a href=#when-simpler-approaches-may-be-appropriate class=hanchor arialabel=Anchor>#</a></h3><p>OBO flow adds complexity. Consider simpler alternatives when:</p><ul><li><strong>Risk tolerance is high</strong> - If your team is small, services are internal, and compromise isn&rsquo;t catastrophic</li><li><strong>Time constraints</strong> - Maturity of your security posture vs. time to ship</li><li><strong>Service count is very low</strong> - 1-2 services where shared tokens are manageable</li><li><strong>IdP limitations</strong> - Your IdP doesn&rsquo;t support OBO flow well or reliably</li></ul><p>The key is to make an informed decision based on your specific requirements, risk tolerance, and operational context. OBO flow isn&rsquo;t always the right answer-but when user context and security matter, it often is.</p><h2 id=the-obo-flow-step-by-step>The OBO Flow: Step by Step<a href=#the-obo-flow-step-by-step class=hanchor arialabel=Anchor>#</a></h2><p>Here&rsquo;s the complete flow, with actual HTTP requests:</p><h3 id=step-1-user-authenticates-standard-oauth2>Step 1: User Authenticates (Standard OAuth2)<a href=#step-1-user-authenticates-standard-oauth2 class=hanchor arialabel=Anchor>#</a></h3><p>First, the user goes through a standard OAuth2 authorization code flow:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>GET /authorize?
</span></span><span style=display:flex><span>    response_type=code&amp;
</span></span><span style=display:flex><span>    client_id=your_client_id&amp;
</span></span><span style=display:flex><span>    redirect_uri=https://your-app.com/callback&amp;
</span></span><span style=display:flex><span>    scope=openid profile email
</span></span></code></pre></div><p>User logs in, you get an authorization code, exchange it for tokens:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#a6e22e>POST</span> /token <span style=color:#66d9ef>HTTP</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1.1</span>
</span></span><span style=display:flex><span>Host<span style=color:#f92672>:</span> <span style=color:#ae81ff>auth.example.com</span>
</span></span><span style=display:flex><span>Content-Type<span style=color:#f92672>:</span> <span style=color:#ae81ff>application/x-www-form-urlencoded</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>grant_type=authorization_code&amp;
</span></span><span style=display:flex><span>code=SplxlOBeZQQYbYS6WxSbIA&amp;
</span></span><span style=display:flex><span>redirect_uri=https://your-app.com/callback&amp;
</span></span><span style=display:flex><span>client_id=your_client_id&amp;
</span></span><span style=display:flex><span>client_secret=your_client_secret
</span></span></code></pre></div><p>Response:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;access_token&#34;</span>: <span style=color:#e6db74>&#34;eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIs...&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;token_type&#34;</span>: <span style=color:#e6db74>&#34;Bearer&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;expires_in&#34;</span>: <span style=color:#ae81ff>3600</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;refresh_token&#34;</span>: <span style=color:#e6db74>&#34;tGzv3JOkF0XG5Qx2TlKWIA&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=step-2-service-a-receives-the-token>Step 2: Service A Receives the Token<a href=#step-2-service-a-receives-the-token class=hanchor arialabel=Anchor>#</a></h3><p>The client (web app, mobile app) now holds <code>access_token</code> and makes requests to Service A:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#a6e22e>GET</span> /api/user/profile <span style=color:#66d9ef>HTTP</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1.1</span>
</span></span><span style=display:flex><span>Host<span style=color:#f92672>:</span> <span style=color:#ae81ff>api.example.com</span>
</span></span><span style=display:flex><span>Authorization<span style=color:#f92672>:</span> <span style=color:#ae81ff>Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIs...</span>
</span></span></code></pre></div><h3 id=step-3-service-a-needs-to-call-service-b-obo-begins>Step 3: Service A Needs to Call Service B (OBO Begins!)<a href=#step-3-service-a-needs-to-call-service-b-obo-begins class=hanchor arialabel=Anchor>#</a></h3><p>Service A needs user data from Service B. Instead of forwarding the original token (which has the wrong scopes), it exchanges it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#a6e22e>POST</span> /token <span style=color:#66d9ef>HTTP</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1.1</span>
</span></span><span style=display:flex><span>Host<span style=color:#f92672>:</span> <span style=color:#ae81ff>auth.example.com</span>
</span></span><span style=display:flex><span>Content-Type<span style=color:#f92672>:</span> <span style=color:#ae81ff>application/x-www-form-urlencoded</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&amp;
</span></span><span style=display:flex><span>assertion=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIs...&amp;
</span></span><span style=display:flex><span>requested_token_use=on_behalf_of&amp;
</span></span><span style=display:flex><span>scope=openid profile user.read&amp;
</span></span><span style=display:flex><span>client_id=service_a_client_id&amp;
</span></span><span style=display:flex><span>client_secret=service_a_client_secret
</span></span></code></pre></div><p>Key parameters:</p><ul><li><code>grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer</code> - This is the OBO grant type</li><li><code>assertion</code> - The incoming access token from the client</li><li><code>requested_token_use=on_behalf_of</code> - Tells the IdP this is an OBO request</li><li><code>client_id</code>/<code>client_secret</code> - Service A&rsquo;s own credentials (NOT the user&rsquo;s!)</li></ul><p>Response:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;access_token&#34;</span>: <span style=color:#e6db74>&#34;eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6...&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;token_type&#34;</span>: <span style=color:#e6db74>&#34;Bearer&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;expires_in&#34;</span>: <span style=color:#ae81ff>3600</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;scope&#34;</span>: <span style=color:#e6db74>&#34;openid profile user.read&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Notice the new <code>access_token</code> is different-it&rsquo;s scoped for Service B.</p><h3 id=step-4-service-a-calls-service-b>Step 4: Service A Calls Service B<a href=#step-4-service-a-calls-service-b class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#a6e22e>GET</span> /api/internal/user/details <span style=color:#66d9ef>HTTP</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1.1</span>
</span></span><span style=display:flex><span>Host<span style=color:#f92672>:</span> <span style=color:#ae81ff>user-service.example.com</span>
</span></span><span style=display:flex><span>Authorization<span style=color:#f92672>:</span> <span style=color:#ae81ff>Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6...</span>
</span></span></code></pre></div><p>Service B validates the token, extracts the user&rsquo;s identity, and returns the data.</p><h2 id=security-considerations>Security Considerations<a href=#security-considerations class=hanchor arialabel=Anchor>#</a></h2><h3 id=1-token-validation-at-every-service>1. <strong>Token Validation at Every Service</strong><a href=#1-token-validation-at-every-service class=hanchor arialabel=Anchor>#</a></h3><p>Every service MUST validate incoming tokens:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Go example using https://github.com/coreos/go-oidc</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>provider</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>oidc</span>.<span style=color:#a6e22e>NewProvider</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#e6db74>&#34;https://auth.example.com&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>verifier</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>provider</span>.<span style=color:#a6e22e>Verifier</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>oidc</span>.<span style=color:#a6e22e>Config</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ClientID</span>: <span style=color:#e6db74>&#34;your_client_id&#34;</span>,
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>token</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Replace</span>(<span style=color:#a6e22e>authHeader</span>, <span style=color:#e6db74>&#34;Bearer &#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>idToken</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>verifier</span>.<span style=color:#a6e22e>Verify</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>token</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Invalid token</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Extract claims</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>claims</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Email</span>    <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;email&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Verified</span> <span style=color:#66d9ef>bool</span>   <span style=color:#e6db74>`json:&#34;email_verified&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Scopes</span>   []<span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;scope&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>idToken</span>.<span style=color:#a6e22e>Claims</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>claims</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=2-scope-validation>2. <strong>Scope Validation</strong><a href=#2-scope-validation class=hanchor arialabel=Anchor>#</a></h3><p>Don&rsquo;t just verify the token-verify it has the right scopes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Python example</span>
</span></span><span style=display:flex><span>required_scopes <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;user.read&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> required_scopes:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>  <span style=color:#75715e># No scopes required</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>token_scopes <span style=color:#f92672>=</span> set(claims<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;scope&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>)<span style=color:#f92672>.</span>split())
</span></span><span style=display:flex><span>has_all_scopes <span style=color:#f92672>=</span> all(scope <span style=color:#f92672>in</span> token_scopes <span style=color:#66d9ef>for</span> scope <span style=color:#f92672>in</span> required_scopes)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> has_all_scopes:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> jsonify({<span style=color:#e6db74>&#34;error&#34;</span>: <span style=color:#e6db74>&#34;insufficient_scope&#34;</span>}), <span style=color:#ae81ff>403</span>
</span></span></code></pre></div><h3 id=3-client-credential-rotation>3. <strong>Client Credential Rotation</strong><a href=#3-client-credential-rotation class=hanchor arialabel=Anchor>#</a></h3><p>Rotate client secrets regularly. Use short-lived tokens (5-15 minutes is reasonable for microservices).</p><h3 id=4-https-everywhere>4. <strong>HTTPS Everywhere</strong><a href=#4-https-everywhere class=hanchor arialabel=Anchor>#</a></h3><p>All token exchanges MUST be over HTTPS. Never, ever expose tokens in URLs or logs.</p><h3 id=5-token-caching>5. <strong>Token Caching</strong><a href=#5-token-caching class=hanchor arialabel=Anchor>#</a></h3><p>Cache exchanged tokens to reduce load on your IdP, but always respect <code>expires_in</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Java pseudo-code</span>
</span></span><span style=display:flex><span>Cache<span style=color:#f92672>&lt;</span>String, TokenResponse<span style=color:#f92672>&gt;</span> tokenCache <span style=color:#f92672>=</span> Caffeine.<span style=color:#a6e22e>newBuilder</span>()
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>expireAfterWrite</span>(Duration.<span style=color:#a6e22e>ofMinutes</span>(5))
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getObOtoken</span>(String originalToken, String targetScope) {
</span></span><span style=display:flex><span>    String cacheKey <span style=color:#f92672>=</span> originalToken <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#f92672>+</span> targetScope;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> tokenCache.<span style=color:#a6e22e>get</span>(cacheKey, key <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> exchangeToken(originalToken, targetScope);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=threat-model-what-obo-flow-protects-against-and-what-it-doesnt>Threat Model: What OBO Flow Protects Against (And What It Doesn&rsquo;t)<a href=#threat-model-what-obo-flow-protects-against-and-what-it-doesnt class=hanchor arialabel=Anchor>#</a></h2><p>OBO flow isn&rsquo;t a silver bullet. It&rsquo;s a powerful pattern that mitigates specific threats, but it doesn&rsquo;t solve all security problems. Here&rsquo;s a realistic threat matrix.</p><h3 id=threats-obo-flow-mitigates>Threats OBO Flow Mitigates<a href=#threats-obo-flow-mitigates class=hanchor arialabel=Anchor>#</a></h3><table><thead><tr><th>Threat</th><th>OBO Flow Protection</th><th>Why It Works</th></tr></thead><tbody><tr><td><strong>Credential Theft & Spread</strong></td><td>✅ Strong</td><td>User credentials never leave the IdP. Services only hold their own client credentials, not user passwords.</td></tr><tr><td><strong>Token Replay Across Services</strong></td><td>✅ Strong (with <code>aud</code> claim)</td><td>Each OBO token has a specific <code>aud</code> claim. A token for User Service cannot be used against Order Service.</td></tr><tr><td><strong>Compromised Service → Full System Access</strong></td><td>✅ Strong</td><td>If API Gateway is compromised, attacker gets gateway tokens. They&rsquo;d need to exchange tokens for each service, and each exchange requires the service&rsquo;s client credentials (which attacker doesn&rsquo;t have).</td></tr><tr><td><strong>Privilege Escalation via Token Reuse</strong></td><td>✅ Strong</td><td>Token scopes are enforced per service. A token with <code>user.read</code> can&rsquo;t magically gain <code>user.delete</code> through OBO exchange.</td></tr><tr><td><strong>Service Impersonation</strong></td><td>✅ Strong</td><td>Each service uses its own <code>client_id</code>/<code>client_secret</code>. Service A can&rsquo;t exchange a token for Service B without Service A&rsquo;s credentials.</td></tr><tr><td><strong>Stolen Token Long-Term Abuse</strong></td><td>✅ Moderate</td><td>Short token lifetimes (5-15 min) limit the window of opportunity. Even if a token is stolen, it expires quickly.</td></tr><tr><td><strong>Lateral Movement</strong></td><td>✅ Moderate</td><td>Attacker can&rsquo;t simply take a token from one service and use it everywhere. Each service requires its own token exchange.</td></tr></tbody></table><h3 id=threats-obo-flow-does-not-protect-against>Threats OBO Flow Does NOT Protect Against<a href=#threats-obo-flow-does-not-protect-against class=hanchor arialabel=Anchor>#</a></h3><table><thead><tr><th>Threat</th><th>OBO Flow Protection</th><th>What You Need Instead</th></tr></thead><tbody><tr><td><strong>Compromised Identity Provider</strong></td><td>❌ None</td><td>If your IdP (Azure AD, Auth0, etc.) is compromised, all bets are off. Secure your IdP aggressively.</td></tr><tr><td><strong>Service Code Injection / RCE</strong></td><td>❌ None</td><td>OBO protects authentication, not application security. Use secure coding practices, input validation, sandboxing.</td></tr><tr><td><strong>Network Eavesdropping (MITM)</strong></td><td>❌ None (partial)</td><td>OBO flow uses HTTPS, but that&rsquo;s transport security, not OBO-specific. Use proper TLS, certificate pinning, HSTS.</td></tr><tr><td><strong>Zero-Day in Service Runtime</strong></td><td>❌ None</td><td>OBO doesn&rsquo;t patch vulnerabilities in your services. Patch promptly, use security scanning.</td></tr><tr><td><strong>Insider Threat / Rogue Admin</strong></td><td>❌ None</td><td>If someone has admin access to your IdP or services, OBO won&rsquo;t stop them. Use principle of least privilege, audit logging.</td></tr><tr><td><strong>Compromised Service with Legitimate Access</strong></td><td>⚠️ Limited</td><td>If Service A is compromised and legitimately has <code>user.read</code> scope, it can still read user data. OBO doesn&rsquo;t limit what a compromised service can legitimately do.</td></tr><tr><td><strong>Social Engineering / Phishing</strong></td><td>❌ None</td><td>Users can still be tricked into giving up their tokens. Use MFA, security awareness training.</td></tr><tr><td><strong>Token Replay Within Valid Window</strong></td><td>⚠️ Limited</td><td>If an attacker steals a token, they can use it until it expires. OBO limits the scope and audience, but doesn&rsquo;t prevent replay during the token&rsquo;s lifetime.</td></tr></tbody></table><h3 id=real-world-scenario-compromised-api-gateway>Real-World Scenario: Compromised API Gateway<a href=#real-world-scenario-compromised-api-gateway class=hanchor arialabel=Anchor>#</a></h3><p>Let&rsquo;s walk through what happens when your API Gateway is compromised.</p><p><strong>Scenario:</strong> Attacker gains RCE on API Gateway.</p><p><strong>Without OBO flow (shared tokens):</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>1. Attacker reads gateway&#39;s client credentials
</span></span><span style=display:flex><span>2. Attacker generates tokens for ANY scope
</span></span><span style=display:flex><span>3. Attacker accesses Order Service, Payment Service, User Service
</span></span><span style=display:flex><span>4. Complete system compromise
</span></span></code></pre></div><p><strong>With OBO flow:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>1. Attacker reads gateway&#39;s client credentials
</span></span><span style=display:flex><span>2. Attacker can only exchange tokens using gateway&#39;s credentials
</span></span><span style=display:flex><span>3. Gateway has limited scopes (e.g., `user.read`, `order.read`)
</span></span><span style=display:flex><span>4. Attacker exchanges token for User Service → gets `user.read` token
</span></span><span style=display:flex><span>5. Attacker tries to exchange for Payment Service → IdP rejects (no `payment.write` scope)
</span></span><span style=display:flex><span>6. Attacker can&#39;t escalate to admin scopes
</span></span><span style=display:flex><span>7. Damage is contained to what gateway legitimately could do
</span></span></code></pre></div><p><strong>Critical difference:</strong> OBO flow enforces <strong>principle of least privilege</strong> at the token level. A compromised service can only do what it was designed to do, not everything.</p><h3 id=limitations-and-caveats>Limitations and Caveats<a href=#limitations-and-caveats class=hanchor arialabel=Anchor>#</a></h3><p><strong>OBO flow is NOT a replacement for:</strong></p><ol><li><strong>Network segmentation</strong> - Put services in separate VPCs, use service meshes</li><li><strong>Application security</strong> - Input validation, output encoding, secure libraries</li><li><strong>Secrets management</strong> - Rotate client secrets, use vaults (HashiCorp Vault, AWS Secrets Manager)</li><li><strong>Monitoring and alerting</strong> - Detect anomalous token exchange patterns</li><li><strong>Rate limiting</strong> - Prevent brute force on token exchange endpoints</li></ol><p><strong>OBO flow IS a replacement for:</strong></p><ol><li><strong>Storing user passwords in multiple services</strong> - Never do this</li><li><strong>Trusting tokens blindly</strong> - Always validate, verify scopes, check <code>aud</code></li><li><strong>Long-lived tokens for microservices</strong> - Keep them short (5-15 min)</li><li><strong>Shared credentials across services</strong> - Each service gets its own client</li></ol><h3 id=defense-in-depth>Defense in Depth<a href=#defense-in-depth class=hanchor arialabel=Anchor>#</a></h3><p>OBO flow works best as part of a layered defense:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>┌─────────────────────────────────────────┐
</span></span><span style=display:flex><span>│         Network Security (VPC, TLS)       │
</span></span><span style=display:flex><span>├─────────────────────────────────────────┤
</span></span><span style=display:flex><span>│         OBO Flow (Zero Trust Auth)       │
</span></span><span style=display:flex><span>├─────────────────────────────────────────┤
</span></span><span style=display:flex><span>│   Application Security (Input Validation)│
</span></span><span style=display:flex><span>├─────────────────────────────────────────┤
</span></span><span style=display:flex><span>│         Monitoring &amp; Alerting            │
</span></span><span style=display:flex><span>└─────────────────────────────────────────┘
</span></span></code></pre></div><p>If one layer fails, the others still protect you. OBO flow is the <strong>authentication layer</strong>-it&rsquo;s critical, but not sufficient on its own.</p><h2 id=common-pitfalls>Common Pitfalls<a href=#common-pitfalls class=hanchor arialabel=Anchor>#</a></h2><h3 id=pitfall-1-forwarding-the-original-token>Pitfall 1: Forwarding the Original Token<a href=#pitfall-1-forwarding-the-original-token class=hanchor arialabel=Anchor>#</a></h3><p>❌ <strong>Wrong:</strong> Service A forwards the client&rsquo;s token to Service B</p><p>The problem: The original token might not have the right scopes, or Service B might not be configured to accept it.</p><p>✅ <strong>Right:</strong> Service A exchanges the token for a Service B-specific token</p><h3 id=pitfall-2-storing-user-credentials>Pitfall 2: Storing User Credentials<a href=#pitfall-2-storing-user-credentials class=hanchor arialabel=Anchor>#</a></h3><p>❌ <strong>Wrong:</strong> Services store user passwords or refresh tokens</p><p>This violates the zero trust principle and creates massive security risk.</p><p>✅ <strong>Right:</strong> Each service only holds its own client credentials, never the user&rsquo;s</p><h3 id=pitfall-3-ignoring-token-expiry>Pitfall 3: Ignoring Token Expiry<a href=#pitfall-3-ignoring-token-expiry class=hanchor arialabel=Anchor>#</a></h3><p>❌ <strong>Wrong:</strong> Using tokens indefinitely or caching them for too long</p><p>Tokens expire for a reason-respect it.</p><p>✅ <strong>Right:</strong> Always check <code>expires_in</code> and refresh tokens proactively</p><h3 id=pitfall-4-missing-audience-aud-claim>Pitfall 4: Missing Audience (aud) Claim<a href=#pitfall-4-missing-audience-aud-claim class=hanchor arialabel=Anchor>#</a></h3><p>❌ <strong>Wrong:</strong> Tokens without an <code>aud</code> claim can be replayed across services</p><p>✅ <strong>Right:</strong> Ensure each OBO token has a specific <code>aud</code> claim for the target service</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;aud&#34;</span>: <span style=color:#e6db74>&#34;user-service.example.com&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;sub&#34;</span>: <span style=color:#e6db74>&#34;user123&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;scope&#34;</span>: <span style=color:#e6db74>&#34;user.read&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=implementation-examples>Implementation Examples<a href=#implementation-examples class=hanchor arialabel=Anchor>#</a></h2><h3 id=azure-ad-microsoft-entra-id>Azure AD (Microsoft Entra ID)<a href=#azure-ad-microsoft-entra-id class=hanchor arialabel=Anchor>#</a></h3><p>Azure AD has first-class OBO support:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#a6e22e>POST</span> /{tenant}/oauth2/v2.0/token <span style=color:#66d9ef>HTTP</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1.1</span>
</span></span><span style=display:flex><span>Host<span style=color:#f92672>:</span> <span style=color:#ae81ff>login.microsoftonline.com</span>
</span></span><span style=display:flex><span>Content-Type<span style=color:#f92672>:</span> <span style=color:#ae81ff>application/x-www-form-urlencoded</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&amp;
</span></span><span style=display:flex><span>client_id={service_a_client_id}&amp;
</span></span><span style=display:flex><span>client_secret={service_a_client_secret}&amp;
</span></span><span style=display:flex><span>assertion={incoming_token}&amp;
</span></span><span style=display:flex><span>requested_token_use=on_behalf_of&amp;
</span></span><span style=display:flex><span>scope=https://graph.microsoft.com/user.read
</span></span></code></pre></div><p><a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-on-behalf-of-flow>Microsoft Documentation</a></p><h3 id=auth0>Auth0<a href=#auth0 class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#a6e22e>POST</span> /oauth/token <span style=color:#66d9ef>HTTP</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1.1</span>
</span></span><span style=display:flex><span>Host<span style=color:#f92672>:</span> <span style=color:#ae81ff>{tenant}.auth0.com</span>
</span></span><span style=display:flex><span>Content-Type<span style=color:#f92672>:</span> <span style=color:#ae81ff>application/json</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;grant_type&#34;</span>: <span style=color:#e6db74>&#34;urn:ietf:params:oauth:grant-type:jwt-bearer&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;client_id&#34;</span>: <span style=color:#e6db74>&#34;{service_a_client_id}&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;client_secret&#34;</span>: <span style=color:#e6db74>&#34;{service_a_client_secret}&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;audience&#34;</span>: <span style=color:#e6db74>&#34;https://user-service.example.com&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;subject_token&#34;</span>: <span style=color:#e6db74>&#34;{incoming_token}&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;subject_token_type&#34;</span>: <span style=color:#e6db74>&#34;urn:ietf:params:oauth:token-type:access_token&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><a href=https://auth0.com/docs/api/authentication#resource-owner-password>Auth0 Documentation</a></p><h3 id=keycloak>Keycloak<a href=#keycloak class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#a6e22e>POST</span> /realms/{realm}/protocol/openid-connect/token <span style=color:#66d9ef>HTTP</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1.1</span>
</span></span><span style=display:flex><span>Host<span style=color:#f92672>:</span> <span style=color:#ae81ff>keycloak.example.com</span>
</span></span><span style=display:flex><span>Content-Type<span style=color:#f92672>:</span> <span style=color:#ae81ff>application/x-www-form-urlencoded</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&amp;
</span></span><span style=display:flex><span>assertion={incoming_token}&amp;
</span></span><span style=display:flex><span>requested_token_use=on_behalf_of&amp;
</span></span><span style=display:flex><span>scope=openid profile&amp;
</span></span><span style=display:flex><span>client_id={service_a_client_id}&amp;
</span></span><span style=display:flex><span>client_secret={service_a_client_secret}
</span></span></code></pre></div><p><a href=https://www.keycloak.org/docs/latest/securing_apps/index.html#_token-exchange>Keycloak Documentation</a></p><h2 id=alternative-token-introspection>Alternative: Token Introspection<a href=#alternative-token-introspection class=hanchor arialabel=Anchor>#</a></h2><p>Some IdPs (like Keycloak) support token introspection as an alternative to OBO:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#a6e22e>POST</span> /introspect <span style=color:#66d9ef>HTTP</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1.1</span>
</span></span><span style=display:flex><span>Host<span style=color:#f92672>:</span> <span style=color:#ae81ff>auth.example.com</span>
</span></span><span style=display:flex><span>Content-Type<span style=color:#f92672>:</span> <span style=color:#ae81ff>application/x-www-form-urlencoded</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>client_id={service_a_client_id}&amp;
</span></span><span style=display:flex><span>client_secret={service_a_client_secret}&amp;
</span></span><span style=display:flex><span>token={incoming_token}
</span></span></code></pre></div><p>Response:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;active&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;sub&#34;</span>: <span style=color:#e6db74>&#34;user123&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;scope&#34;</span>: <span style=color:#e6db74>&#34;openid profile email&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;client_id&#34;</span>: <span style=color:#e6db74>&#34;api_gateway&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;exp&#34;</span>: <span style=color:#ae81ff>1500000000</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This validates the token without issuing a new one. Use when you don&rsquo;t need new scopes-just validation.</p><h2 id=performance-optimisations>Performance Optimisations<a href=#performance-optimisations class=hanchor arialabel=Anchor>#</a></h2><h3 id=1-token-exchange-caching>1. <strong>Token Exchange Caching</strong><a href=#1-token-exchange-caching class=hanchor arialabel=Anchor>#</a></h3><p>Cache OBO exchanges with a TTL slightly less than <code>expires_in</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>CachedToken</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Token</span>     <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ExpiresAt</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>exchangeCache</span> = make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>CachedToken</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>cacheMutex</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getObOtoken</span>(<span style=color:#a6e22e>originalToken</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>scope</span> <span style=color:#66d9ef>string</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cacheKey</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>originalToken</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>scope</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check cache</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cacheMutex</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cached</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>exchangeCache</span>[<span style=color:#a6e22e>cacheKey</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cacheMutex</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>Before</span>(<span style=color:#a6e22e>cached</span>.<span style=color:#a6e22e>ExpiresAt</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cached</span>.<span style=color:#a6e22e>Token</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Perform exchange</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>newToken</span>, <span style=color:#a6e22e>expires</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>performTokenExchange</span>(<span style=color:#a6e22e>originalToken</span>, <span style=color:#a6e22e>scope</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Cache it (expire 1 minute early)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cacheMutex</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>exchangeCache</span>[<span style=color:#a6e22e>cacheKey</span>] = <span style=color:#a6e22e>CachedToken</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Token</span>:     <span style=color:#a6e22e>newToken</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ExpiresAt</span>: <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#a6e22e>expires</span><span style=color:#f92672>-</span><span style=color:#ae81ff>60</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cacheMutex</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>newToken</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=2-asynchronous-token-refresh>2. <strong>Asynchronous Token Refresh</strong><a href=#2-asynchronous-token-refresh class=hanchor arialabel=Anchor>#</a></h3><p>Don&rsquo;t block requests on token refresh. Use a background goroutine:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>startTokenRefresher</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ticker</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>NewTicker</span>(<span style=color:#ae81ff>30</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ticker</span>.<span style=color:#a6e22e>C</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>refreshExpiringTokens</span>()
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=3-connection-pooling>3. <strong>Connection Pooling</strong><a href=#3-connection-pooling class=hanchor arialabel=Anchor>#</a></h3><p>Reuse HTTP connections to your IdP:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>session <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>Session()
</span></span><span style=display:flex><span>session<span style=color:#f92672>.</span>mount(<span style=color:#e6db74>&#39;https://&#39;</span>, requests<span style=color:#f92672>.</span>adapters<span style=color:#f92672>.</span>HTTPAdapter(
</span></span><span style=display:flex><span>    pool_connections<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>,
</span></span><span style=display:flex><span>    pool_maxsize<span style=color:#f92672>=</span><span style=color:#ae81ff>100</span>,
</span></span><span style=display:flex><span>    max_retries<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>))
</span></span></code></pre></div><h2 id=data-caching-security-vs-performance-trade-offs>Data Caching: Security vs Performance Trade-Offs<a href=#data-caching-security-vs-performance-trade-offs class=hanchor arialabel=Anchor>#</a></h2><p>When using OBO flow, you&rsquo;ll face a common dilemma: cache data on your platform for performance, or fetch it in real-time for security? There&rsquo;s no universal answer-only trade-offs based on your risk tolerance.</p><h3 id=real-time-fetching-no-caching>Real-Time Fetching (No Caching)<a href=#real-time-fetching-no-caching class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>Platform → Backend API → Return data to user
</span></span><span style=display:flex><span>           (no storage)
</span></span></code></pre></div><p><strong>Pros:</strong></p><ul><li><strong>No cached data exposure</strong> - If platform is compromised, there&rsquo;s nothing to steal</li><li><strong>Trust boundary intact</strong> - Data stays in your backend services, never persisted to platform</li><li><strong>Regulatory compliance</strong> - Easier to meet GDPR, HIPAA, data residency requirements</li><li><strong>Fresh data</strong> - Users always see the latest information</li></ul><p><strong>Cons:</strong></p><ul><li><strong>Slower UX</strong> - Every request requires backend round-trip</li><li><strong>Higher backend load</strong> - More traffic to your services</li><li><strong>Limited scalability</strong> - Harder to handle traffic spikes</li></ul><p><strong>Use when:</strong></p><ul><li>Data is sensitive (personal info, financial records, PII)</li><li>Real-time accuracy matters (stock prices, account balances)</li><li>Regulatory requirements forbid data storage in third-party platforms</li><li>Performance requirements are modest</li></ul><h3 id=caching-on-platform>Caching on Platform<a href=#caching-on-platform class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>Platform → Backend API → Cache data locally → Return to user
</span></span><span style=display:flex><span>                        (storage)
</span></span></code></pre></div><p><strong>Pros:</strong></p><ul><li><strong>Fast UX</strong> - Sub-second response times</li><li><strong>Lower backend load</strong> - Fewer API calls</li><li><strong>Better scalability</strong> - Can handle traffic spikes</li><li><strong>Cost reduction</strong> - Fewer API calls = lower infrastructure costs</li></ul><p><strong>Cons:</strong></p><ul><li><strong>Cached data exposed</strong> - If platform is compromised, cached data is stolen</li><li><strong>Trust boundary broken</strong> - Data now lives outside your control</li><li><strong>Stale data risk</strong> - Users may see outdated information</li><li><strong>Regulatory complexity</strong> - May violate data residency or retention policies</li></ul><p><strong>Use when:</strong></p><ul><li>Data is non-sensitive (public catalogs, configuration)</li><li>Performance is critical (user-facing dashboards, analytics)</li><li>Data changes infrequently (product prices, static content)</li><li>Risk tolerance is acceptable</li></ul><h3 id=decision-framework-1>Decision Framework<a href=#decision-framework-1 class=hanchor arialabel=Anchor>#</a></h3><table><thead><tr><th>Consideration</th><th>Real-Time</th><th>Cached</th></tr></thead><tbody><tr><td><strong>Data sensitivity</strong></td><td>Personal/financial data</td><td>Public/anonymized data</td></tr><tr><td><strong>Performance requirements</strong></td><td>Not latency-critical</td><td>Sub-second response times</td></tr><tr><td><strong>Compromise tolerance</strong></td><td>Zero tolerance</td><td>Acceptable risk</td></tr><tr><td><strong>Regulatory requirements</strong></td><td>GDPR/HIPAA strictness</td><td>Less strict</td></tr><tr><td><strong>Data freshness</strong></td><td>Real-time critical</td><td>Staleness acceptable</td></tr><tr><td><strong>Traffic patterns</strong></td><td>Consistent, predictable</td><td>Spiky, burst-heavy</td></tr></tbody></table><h3 id=hybrid-approach-often-best>Hybrid Approach (Often Best)<a href=#hybrid-approach-often-best class=hanchor arialabel=Anchor>#</a></h3><p>Mix real-time and cached based on data sensitivity:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>DataFetcher</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cache</span> <span style=color:#a6e22e>Cache</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>backend</span> <span style=color:#a6e22e>BackendAPI</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DataFetcher</span>) <span style=color:#a6e22e>FetchUser</span>(<span style=color:#a6e22e>userID</span> <span style=color:#66d9ef>string</span>) (<span style=color:#a6e22e>UserData</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Sensitive data - always real-time</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>backend</span>.<span style=color:#a6e22e>FetchUser</span>(<span style=color:#a6e22e>userID</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DataFetcher</span>) <span style=color:#a6e22e>FetchProducts</span>() ([]<span style=color:#a6e22e>Product</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Public data - cache aggressively</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cached</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;products&#34;</span>); <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cached</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>products</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>backend</span>.<span style=color:#a6e22e>FetchProducts</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;products&#34;</span>, <span style=color:#a6e22e>products</span>, <span style=color:#ae81ff>5</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Minute</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>products</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DataFetcher</span>) <span style=color:#a6e22e>FetchRecentActivity</span>(<span style=color:#a6e22e>userID</span> <span style=color:#66d9ef>string</span>) ([]<span style=color:#a6e22e>Activity</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Semi-sensitive - short cache</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cacheKey</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;activity:&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>userID</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cached</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>cacheKey</span>); <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cached</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>activity</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>backend</span>.<span style=color:#a6e22e>FetchRecentActivity</span>(<span style=color:#a6e22e>userID</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>cacheKey</span>, <span style=color:#a6e22e>activity</span>, <span style=color:#ae81ff>1</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Minute</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>activity</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=caching-strategies-for-sensitive-data>Caching Strategies for Sensitive Data<a href=#caching-strategies-for-sensitive-data class=hanchor arialabel=Anchor>#</a></h3><p>If you must cache sensitive data, follow these guidelines:</p><p><strong>1. Memory-Only Caching</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>✅ Do: Use in-memory caches (Redis, Memcached)
</span></span><span style=display:flex><span>❌ Don&#39;t: Persist to disk or database
</span></span></code></pre></div><p>Why? If the platform is compromised, in-memory cache is lost on restart or can be wiped quickly. Persistent storage is harder to clean up.</p><p><strong>2. Short TTL</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 1-5 minutes for sensitive data</span>
</span></span><span style=display:flex><span>cache<span style=color:#f92672>.</span>set(key, value, ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>60</span>)  <span style=color:#75715e># 60 seconds</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Longer for public data</span>
</span></span><span style=display:flex><span>cache<span style=color:#f92672>.</span>set(key, value, ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>300</span>)  <span style=color:#75715e># 5 minutes</span>
</span></span></code></pre></div><p><strong>3. Cache Invalidation on Logout</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>OnUserLogout</span>(<span style=color:#a6e22e>userID</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>DeletePattern</span>(<span style=color:#e6db74>&#34;user:&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>userID</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;:*&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>4. Encrypted Caching</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> cryptography.fernet <span style=color:#f92672>import</span> Fernet
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>key <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>environ[<span style=color:#e6db74>&#39;CACHE_ENCRYPTION_KEY&#39;</span>]
</span></span><span style=display:flex><span>cipher <span style=color:#f92672>=</span> Fernet(key)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>SetSensitiveCache</span>(key, value, ttl):
</span></span><span style=display:flex><span>    encrypted <span style=color:#f92672>=</span> cipher<span style=color:#f92672>.</span>encrypt(json<span style=color:#f92672>.</span>dumps(value)<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>    cache<span style=color:#f92672>.</span>set(key, encrypted, ttl)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>GetSensitiveCache</span>(key):
</span></span><span style=display:flex><span>    encrypted <span style=color:#f92672>=</span> cache<span style=color:#f92672>.</span>get(key)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> encrypted:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>    decrypted <span style=color:#f92672>=</span> cipher<span style=color:#f92672>.</span>decrypt(encrypted)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> json<span style=color:#f92672>.</span>loads(decrypted)
</span></span></code></pre></div><h3 id=real-world-example-user-dashboard>Real-World Example: User Dashboard<a href=#real-world-example-user-dashboard class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>Real-time fetch:
</span></span><span style=display:flex><span>  ✅ User name, email, phone
</span></span><span style=display:flex><span>  ✅ Account balance, payment methods
</span></span><span style=display:flex><span>  ✅ Order history, shipping addresses
</span></span><span style=display:flex><span>  ✅ Personal preferences, notification settings
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Short cache (1-2 min):
</span></span><span style=display:flex><span>  ⚠️ Recent activity feed
</span></span><span style=display:flex><span>  ⚠️ Notification count
</span></span><span style=display:flex><span>  ⚠️ Order status updates
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Long cache (5-30 min):
</span></span><span style=display:flex><span>  ✅ Available products
</span></span><span style=display:flex><span>  ✅ Pricing information
</span></span><span style=display:flex><span>  ✅ Configuration data
</span></span><span style=display:flex><span>  ✅ Public announcements
</span></span></code></pre></div><h3 id=cache-key-design>Cache Key Design<a href=#cache-key-design class=hanchor arialabel=Anchor>#</a></h3><p>Include security context in cache keys to prevent cross-user access:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># ❌ Bad - can be guessed</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>GetUserProfile</span>(userID):
</span></span><span style=display:flex><span>    cache_key <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;profile:</span><span style=color:#e6db74>{</span>userID<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ✅ Good - includes session/token context</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>GetUserProfile</span>(userID, userTokenHash):
</span></span><span style=display:flex><span>    cache_key <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;profile:</span><span style=color:#e6db74>{</span>userID<span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>{</span>userTokenHash<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ✅ Better - role-aware</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>GetUserProfile</span>(userID, userTokenHash, userRole):
</span></span><span style=display:flex><span>    cache_key <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;profile:</span><span style=color:#e6db74>{</span>userID<span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>{</span>userTokenHash<span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>{</span>userRole<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><h3 id=monitoring-cache-security>Monitoring Cache Security<a href=#monitoring-cache-security class=hanchor arialabel=Anchor>#</a></h3><p>Track these metrics:</p><ol><li><strong>Cache hit rate</strong> - High hit rate = more exposure risk if compromised</li><li><strong>Cache key patterns</strong> - Unusual access patterns may indicate compromise</li><li><strong>TTL violations</strong> - Caches living longer than configured</li><li><strong>Cache invalidation</strong> - Are logout events triggering cache cleanup?</li></ol><h3 id=the-bottom-line>The Bottom Line<a href=#the-bottom-line class=hanchor arialabel=Anchor>#</a></h3><p>There&rsquo;s no universal &ldquo;right answer.&rdquo; The key is:</p><ol><li><strong>Classify your data</strong> - What&rsquo;s sensitive vs. public?</li><li><strong>Define your risk tolerance</strong> - What happens if platform is compromised?</li><li><strong>Make intentional decisions</strong> - Document why you&rsquo;re caching (or not)</li><li><strong>Use hybrid strategies</strong> - Real-time for sensitive, cached for public</li><li><strong>Implement safeguards</strong> - Short TTLs, encrypted caches, invalidation on logout</li></ol><p>When in doubt, default to real-time for sensitive data. You can always add caching later if performance becomes an issue, but you can&rsquo;t undo data exposure once it&rsquo;s happened.</p><h2 id=monitoring-and-observability>Monitoring and Observability<a href=#monitoring-and-observability class=hanchor arialabel=Anchor>#</a></h2><h3 id=key-metrics-to-track>Key Metrics to Track<a href=#key-metrics-to-track class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Token Exchange Rate</strong> - How many OBO exchanges per second?</li><li><strong>Token Cache Hit Rate</strong> - Are you effectively caching?</li><li><strong>IdP Response Time</strong> - Slow exchanges hurt your service</li><li><strong>Token Validation Failures</strong> - Security incidents waiting to happen</li><li><strong>Token Expiry Distribution</strong> - Are tokens expiring unexpectedly?</li></ul><p>To measure any of this you need a couple of metrics. You can do it with generic HTTP metrics (request count/latency to your IdP) but you&rsquo;ll get more useful signal if you emit a few OBO-specific counters.</p><p>Recommended metrics to emit from Service A:</p><ul><li><code>obo_token_exchange_requests_total{target_service, status}</code></li><li><code>obo_token_exchange_duration_seconds_bucket{target_service}</code> (histogram)</li><li><code>obo_token_cache_hits_total{target_service}</code> and <code>obo_token_cache_misses_total{target_service}</code></li></ul><h3 id=prometheus-alert-rules-examples>Prometheus Alert Rules (Examples)<a href=#prometheus-alert-rules-examples class=hanchor arialabel=Anchor>#</a></h3><p>These assume you emit the metrics above.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>groups</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>oauth2_obo</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>alert</span>: <span style=color:#ae81ff>OBOExchangeErrorRateHigh</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>expr</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          sum(rate(obo_token_exchange_requests_total{status=&#34;error&#34;}[5m]))
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          /
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          sum(rate(obo_token_exchange_requests_total[5m]))
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          &gt; 0.02</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>for</span>: <span style=color:#ae81ff>10m</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>severity</span>: <span style=color:#ae81ff>critical</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>summary</span>: <span style=color:#e6db74>&#34;High OBO token exchange error rate&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#34;OBO exchange errors &gt; 2% for 10 minutes&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>alert</span>: <span style=color:#ae81ff>OBOIdPLatencyHighP95</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>expr</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          histogram_quantile(
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            0.95,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            sum by (le) (rate(obo_token_exchange_duration_seconds_bucket[10m]))
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          ) &gt; 0.5</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>for</span>: <span style=color:#ae81ff>10m</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>severity</span>: <span style=color:#ae81ff>warning</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>summary</span>: <span style=color:#e6db74>&#34;OBO token exchange latency high (p95)&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#34;p95 &gt; 500ms for 10 minutes (IdP or network issues)&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>alert</span>: <span style=color:#ae81ff>OBOTokenCacheHitRateLow</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>expr</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          sum(rate(obo_token_cache_hits_total[10m]))
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          /
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          (sum(rate(obo_token_cache_hits_total[10m])) + sum(rate(obo_token_cache_misses_total[10m])))
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          &lt; 0.5</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>for</span>: <span style=color:#ae81ff>30m</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>severity</span>: <span style=color:#ae81ff>info</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>summary</span>: <span style=color:#e6db74>&#34;OBO token cache hit rate low&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#34;Cache hit rate &lt; 50% for 30 minutes (watch IdP load)&#34;</span>
</span></span></code></pre></div><p>Tune thresholds to your environment. The point is to catch the two failures that hurt the most:</p><ul><li>the IdP is slow/down (everything stacks up)</li><li>caching broke (IdP load spikes, latency climbs, then you fall over)</li></ul><h3 id=logging>Logging<a href=#logging class=hanchor arialabel=Anchor>#</a></h3><p>Log token exchanges (without sensitive data):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;timestamp&#34;</span>: <span style=color:#e6db74>&#34;2026-02-04T12:00:00Z&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;service&#34;</span>: <span style=color:#e6db74>&#34;api-gateway&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;event&#34;</span>: <span style=color:#e6db74>&#34;token_exchange&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;target_service&#34;</span>: <span style=color:#e6db74>&#34;user-service&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;token_hash&#34;</span>: <span style=color:#e6db74>&#34;a1b2c3d4...&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;expires_in&#34;</span>: <span style=color:#ae81ff>3600</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;duration_ms&#34;</span>: <span style=color:#ae81ff>45</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=distributed-tracing>Distributed Tracing<a href=#distributed-tracing class=hanchor arialabel=Anchor>#</a></h3><p>Add trace context to OBO exchanges:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#a6e22e>POST</span> /token <span style=color:#66d9ef>HTTP</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1.1</span>
</span></span><span style=display:flex><span>traceparent<span style=color:#f92672>:</span> <span style=color:#ae81ff>00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01</span>
</span></span></code></pre></div><p>This lets you trace a request from client through Service A, Service B, and back.</p><h2 id=production-checklist>Production Checklist<a href=#production-checklist class=hanchor arialabel=Anchor>#</a></h2><p>Before going to production:</p><ul><li><input disabled type=checkbox> All services validate JWT signatures using proper libraries (never roll your own crypto)</li><li><input disabled type=checkbox> Every token exchange uses HTTPS</li><li><input disabled type=checkbox> Client secrets are stored securely (env vars, secret management)</li><li><input disabled type=checkbox> Token caching is implemented with proper TTL handling</li><li><input disabled type=checkbox> Scope validation happens at every service boundary</li><li><input disabled type=checkbox> Token refresh logic handles race conditions gracefully</li><li><input disabled type=checkbox> Monitoring and alerting set up for token exchange failures</li><li><input disabled type=checkbox> IdP is configured with appropriate token lifetimes</li><li><input disabled type=checkbox> Audience (aud) claims are set correctly per service</li><li><input disabled type=checkbox> Token revocation is tested and understood</li><li><input disabled type=checkbox> Rate limiting is in place on token exchange endpoints</li><li><input disabled type=checkbox> Audit logging captures security-relevant events</li><li><input disabled type=checkbox> Disaster recovery plan exists (IdP outage scenario)</li></ul><h2 id=further-reading>Further Reading<a href=#further-reading class=hanchor arialabel=Anchor>#</a></h2><h3 id=oauth2-standards>OAuth2 Standards<a href=#oauth2-standards class=hanchor arialabel=Anchor>#</a></h3><ul><li><a href=https://tools.ietf.org/html/rfc6749>RFC 6749 - OAuth 2.0</a></li><li><a href=https://tools.ietf.org/html/rfc7523>RFC 7523 - JWT Bearer Token Grant</a></li><li><a href=https://tools.ietf.org/html/rfc7519>RFC 7519 - JSON Web Token (JWT)</a></li><li><a href=https://tools.ietf.org/html/rfc7662>RFC 7662 - Token Introspection</a></li></ul><h3 id=idp-specific-documentation>IdP-Specific Documentation<a href=#idp-specific-documentation class=hanchor arialabel=Anchor>#</a></h3><ul><li><a href=https://learn.microsoft.com/en-us/entra/identity-platform/v2-oauth2-on-behalf-of-flow>Microsoft Entra ID OBO flow</a></li><li><a href=https://auth0.com/docs/api/authentication#token-exchange>Auth0 Token Exchange</a></li><li><a href=https://www.keycloak.org/docs/latest/securing_apps/#_token-exchange>Keycloak Token Exchange</a></li><li><a href=https://developer.okta.com/docs/reference/api/oidc/#token-exchange>Okta OAuth2 Flows</a></li></ul><h3 id=libraries-and-tools>Libraries and Tools<a href=#libraries-and-tools class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Go</strong>: <a href=https://github.com/coreos/go-oidc>github.com/coreos/go-oidc</a></li><li><strong>Python</strong>: <a href=https://github.com/lepture/authlib>authlib</a></li><li><strong>Java</strong>: <a href=https://spring.io/projects/spring-security-oauth>Spring Security OAuth</a></li><li><strong>Node.js</strong>: <a href=https://github.com/jaredhanson/passport-oauth2>passport-oauth2</a></li><li><strong>Testing</strong>: <a href=https://jwt.io/>jwt.io</a> - Decode and debug JWTs</li></ul><h3 id=best-practices>Best Practices<a href=#best-practices class=hanchor arialabel=Anchor>#</a></h3><ul><li><a href=https://datatracker.ietf.org/doc/html/draft-ietf-oauth-security-topics>OAuth 2.0 Security Best Current Practice</a></li><li><a href=https://pages.nist.gov/800-63-3/>NIST Digital Identity Guidelines</a></li><li><a href=https://cheatsheetseries.owasp.org/cheatsheets/OAuth2_Cheat_Sheet.html>OWASP OAuth2 Cheat Sheet</a></li></ul><h2 id=conclusion>Conclusion<a href=#conclusion class=hanchor arialabel=Anchor>#</a></h2><p>The OAuth2 OBO flow is a powerful pattern for microservice security, but it&rsquo;s not simple. Done right, it gives you:</p><ul><li>Zero trust architecture (every service verifies identity)</li><li>Fine-grained access control (scopes per service)</li><li>No credential sprawl (user credentials stay at the IdP)</li></ul><p>Done wrong, and you&rsquo;ve got:</p><ul><li>Security vulnerabilities (token replay, scope escalation)</li><li>Performance issues (too many token exchanges)</li><li>Operational nightmares (hard to debug, hard to monitor)</li></ul><p>The key is to understand your requirements, choose the right tools, and implement carefully. Start small, test thoroughly, and scale gradually.</p><p>Got questions? Found a mistake? I&rsquo;m always happy to nerd out about OAuth2.</p><hr><p><em>This post is based on my experience implementing secure microservice architectures across various industries. Your mileage may vary, and you should always consult your security team before implementing in production.</em></p></div></div><div class=related-posts style="margin-top:3rem;padding-top:2rem;border-top:1px solid #333"><h3>Related Posts</h3><ul style=list-style:none;padding:0><li style=margin-bottom:1rem><a href=https://gazsecops.github.io/posts/oauth2-vs-saml-differences/>OAuth2 vs SAML: Which One and Why?</a>
<span style=color:#999;font-size:.9rem>- 10 Nov 2025</span><div style=font-size:.85rem;color:#666;margin-top:.25rem><span style=margin-right:.5rem>#authentication</span>
<span style=margin-right:.5rem>#oauth2</span>
<span style=margin-right:.5rem>#saml</span>
<span style=margin-right:.5rem>#security</span>
<span style=margin-right:.5rem>#enterprise</span></div></li><li style=margin-bottom:1rem><a href=https://gazsecops.github.io/posts/oauth2-security-pitfalls/>OAuth 2.0 Security: What Actually Breaks</a>
<span style=color:#999;font-size:.9rem>- 20 May 2025</span><div style=font-size:.85rem;color:#666;margin-top:.25rem><span style=margin-right:.5rem>#security</span>
<span style=margin-right:.5rem>#oauth2</span>
<span style=margin-right:.5rem>#authentication</span>
<span style=margin-right:.5rem>#web-security</span></div></li><li style=margin-bottom:1rem><a href=https://gazsecops.github.io/posts/saas-paas-gateway-security-pattern/>SaaS + PaaS Gateway Security Pattern: Trust Boundaries and Data Sovereignty</a>
<span style=color:#999;font-size:.9rem>- 11 Feb 2026</span><div style=font-size:.85rem;color:#666;margin-top:.25rem><span style=margin-right:.5rem>#azure</span>
<span style=margin-right:.5rem>#security</span>
<span style=margin-right:.5rem>#saas</span>
<span style=margin-right:.5rem>#architecture</span>
<span style=margin-right:.5rem>#api-gateway</span>
<span style=margin-right:.5rem>#trust-boundary</span></div></li><li style=margin-bottom:1rem><a href=https://gazsecops.github.io/posts/threat-analysis-practical-guide/>Threat Analysis: What Actually Works</a>
<span style=color:#999;font-size:.9rem>- 8 Feb 2026</span><div style=font-size:.85rem;color:#666;margin-top:.25rem><span style=margin-right:.5rem>#security</span>
<span style=margin-right:.5rem>#threat-analysis</span>
<span style=margin-right:.5rem>#risk-management</span>
<span style=margin-right:.5rem>#defense</span>
<span style=margin-right:.5rem>#methodology</span></div></li><li style=margin-bottom:1rem><a href=https://gazsecops.github.io/posts/workload-identity-beyond-api-keys/>Workload Identity: Giving Your Services an Identity Without the Secret Sprawl</a>
<span style=color:#999;font-size:.9rem>- 8 Feb 2026</span><div style=font-size:.85rem;color:#666;margin-top:.25rem><span style=margin-right:.5rem>#security</span>
<span style=margin-right:.5rem>#identity</span>
<span style=margin-right:.5rem>#cloud</span>
<span style=margin-right:.5rem>#kubernetes</span>
<span style=margin-right:.5rem>#spiffe</span>
<span style=margin-right:.5rem>#operations</span></div></li></ul></div><div class=pagination><div class=pagination__title><span class=pagination__title-h></span><hr></div><div class=pagination__buttons><a href=https://gazsecops.github.io/posts/fosdem-2026-recap/ class="button inline prev">&lt; [<span class=button__text>FOSDEM 2026: Brussels, Beer, and Good Tech</span>]
</a>::
<a href=https://gazsecops.github.io/posts/ai-systems-responsibility-part-8/ class="button inline next">[<span class=button__text>AI Systems Responsibility: Part 8 - Practical Tools That Actually Help (Bonus Episode)</span>] ></a></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2026</span></div><div class=build-info><span class=build-commit>e733073</span><span class=build-date>2026-02-12 12:33 UTC</span></div></div></footer></div></body></html>