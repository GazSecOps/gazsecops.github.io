<!doctype html><html lang=en><head><title>Prometheus for Security: Monitoring What Actually Matters :: Gareth's Engineering Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content=" Management: We need better visibility into security events.
Sysadmin: What are you currently monitoring?
Management: Service uptime. CPU. Memory. The usual.
Sysadmin: What about failed logins? Unexpected services? File changes?
Management: That&rsquo;s what the SIEM is for.
Sysadmin: When did you last look at the SIEM?
Management: &mldr;
This is the problem with security monitoring. Teams spend thousands on SIEMs that nobody uses. Meanwhile, Prometheus sits there collecting metrics, and nobody thinks to point it at security problems.
&#34;Security monitoring doesn't need a six-figure SIEM budget. It needs metrics that matter, alerts that fire when something's actually wrong, and people who respond when they do.&#34; Prometheus is already in your infrastructure. It&rsquo;s collecting metrics. It&rsquo;s generating alerts. You just need to point it at the right things.
"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://gazsecops.github.io/posts/prometheus-security-monitoring/><link rel=stylesheet href=https://gazsecops.github.io/css/extended.min.c658c723e006469d82f697e19c5338967fad12c57650bdd915bacf9cfbe2cc38.css><link rel=stylesheet href=https://gazsecops.github.io/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css><link rel=stylesheet href=https://gazsecops.github.io/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css><link rel=stylesheet href=https://gazsecops.github.io/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css><link rel=stylesheet href=https://gazsecops.github.io/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css><link rel=stylesheet href=https://gazsecops.github.io/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css><link rel=stylesheet href=https://gazsecops.github.io/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css><link rel=stylesheet href=https://gazsecops.github.io/css/main.min.36833afd348409fc6c3d09d0897c5833d9d5bf1ff31f5e60ea3ee42ce2b1268c.css><link rel=stylesheet href=https://gazsecops.github.io/css/menu.min.3c17467ebeb3d38663dce68f71f519901124fa5cbb4519b2fb0667a21e9aca39.css><link rel=stylesheet href=https://gazsecops.github.io/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css><link rel=stylesheet href=https://gazsecops.github.io/css/post.min.e6dddd258e64c83e05cec0cd49c05216742d42fc8ecbfbe6b67083412b609bd3.css><link rel=stylesheet href=https://gazsecops.github.io/css/syntax.min.a0773cce9310cb6d8ed23e50f005448facf29a53001b57e038828daa466b25c0.css><link rel=stylesheet href=https://gazsecops.github.io/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css><link rel=stylesheet href=https://gazsecops.github.io/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css><link rel="shortcut icon" href=https://gazsecops.github.io/favicon.png><link rel=apple-touch-icon href=https://gazsecops.github.io/apple-touch-icon.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Prometheus for Security: Monitoring What Actually Matters"><meta property="og:description" content=" Management: We need better visibility into security events.
Sysadmin: What are you currently monitoring?
Management: Service uptime. CPU. Memory. The usual.
Sysadmin: What about failed logins? Unexpected services? File changes?
Management: That&rsquo;s what the SIEM is for.
Sysadmin: When did you last look at the SIEM?
Management: &mldr;
This is the problem with security monitoring. Teams spend thousands on SIEMs that nobody uses. Meanwhile, Prometheus sits there collecting metrics, and nobody thinks to point it at security problems.
&#34;Security monitoring doesn't need a six-figure SIEM budget. It needs metrics that matter, alerts that fire when something's actually wrong, and people who respond when they do.&#34; Prometheus is already in your infrastructure. It&rsquo;s collecting metrics. It&rsquo;s generating alerts. You just need to point it at the right things.
"><meta property="og:url" content="https://gazsecops.github.io/posts/prometheus-security-monitoring/"><meta property="og:site_name" content="Gareth's Engineering Blog"><meta property="og:image" content="https://gazsecops.github.io/og-image.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2024-10-18 10:00:00 +0000 UTC"></head><body><div class="container center"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>gareth@blog:~$</div></a></div><div class=header__search><input type=text id=header-search placeholder="Quick search..." style="padding:5px 10px;background:#222;color:#eee;border:1px solid #444;border-radius:3px;font-size:14px;width:200px"></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;â–¾</li><li><ul class=menu__dropdown><li><a href=/topics/>Topics</a></li><li><a href=/posts/>All</a></li><li><a href=/series/>Series</a></li><li><a href=/tags/>Tags</a></li><li><a href=/archive/>Archive</a></li><li><a href=/search/>Search</a></li><li><a href=/about/>About</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/topics/>Topics</a></li><li><a href=/posts/>All</a></li><li><a href=/series/>Series</a></li><li><a href=/tags/>Tags</a></li><li><a href=/archive/>Archive</a></li><li><a href=/search/>Search</a></li><li><a href=/about/>About</a></li></ul></nav></header><script>(function(){const e=document.getElementById("header-search");if(!e)return;e.addEventListener("keydown",function(e){if(e.key==="Enter"){const e=this.value.trim();e&&(window.location.href="/search?q="+encodeURIComponent(e))}}),document.addEventListener("keydown",function(t){t.key==="/"&&!["INPUT","TEXTAREA"].includes(t.target.tagName)&&(t.preventDefault(),e.focus()),t.key==="Escape"&&t.target===e&&e.blur()})})()</script><style>.header__inner{display:flex;align-items:center;gap:20px}.header__search{flex:none}#header-search::placeholder{color:#666;font-style:italic}#header-search:focus{outline:none;border-color:#888}@media(max-width:684px){.header__search{display:none}}</style><div class=content><article class=post><h1 class=post-title><a href=https://gazsecops.github.io/posts/prometheus-security-monitoring/>Prometheus for Security: Monitoring What Actually Matters</a></h1><div class=post-meta><time class=post-date>2024-10-18</time><span class=post-author>Gareth</span><span class=post-reading-time>12 min read (2492 words)</span></div><span class=post-tags>#<a href=https://gazsecops.github.io/tags/security/>security</a>&nbsp;
#<a href=https://gazsecops.github.io/tags/monitoring/>monitoring</a>&nbsp;
#<a href=https://gazsecops.github.io/tags/prometheus/>prometheus</a>&nbsp;
#<a href=https://gazsecops.github.io/tags/linux/>linux</a>&nbsp;
#<a href=https://gazsecops.github.io/tags/operations/>operations</a>&nbsp;</span><div class=table-of-contents><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#why-prometheus-for-security-monitoring>Why Prometheus for Security Monitoring</a></li><li><a href=#the-cases-where-it-works>The Cases Where It Works</a><ul><li><a href=#ssh-brute-force-detection>SSH Brute Force Detection</a></li><li><a href=#cicd-pipeline-security>CI/CD Pipeline Security</a></li><li><a href=#file-integrity-monitoring>File Integrity Monitoring</a></li><li><a href=#container-security-monitoring>Container Security Monitoring</a></li><li><a href=#dns-exfiltration-detection>DNS Exfiltration Detection</a></li></ul></li><li><a href=#what-prometheus-doesnt-do>What Prometheus Doesn&rsquo;t Do</a></li><li><a href=#making-alerts-useful>Making Alerts Useful</a></li><li><a href=#securing-prometheus-itself>Securing Prometheus Itself</a><ul><li><a href=#keep-it-private>Keep It Private</a></li><li><a href=#add-authentication-prometheus-doesnt-do-this-for-you>Add Authentication (Prometheus Doesn&rsquo;t Do This For You)</a></li><li><a href=#use-tls-for-scrapes-or-keep-scrapes-on-a-trusted-network>Use TLS For Scrapes (Or Keep Scrapes On A Trusted Network)</a></li><li><a href=#treat-exporters-like-attack-surface>Treat Exporters Like Attack Surface</a></li><li><a href=#dont-leak-secrets-into-labels>Don&rsquo;t Leak Secrets Into Labels</a></li><li><a href=#lock-down-grafana-too>Lock Down Grafana Too</a></li><li><a href=#common-mistakes>Common Mistakes</a></li></ul></li><li><a href=#when-to-use-something-else>When to Use Something Else</a></li><li><a href=#getting-started>Getting Started</a></li><li><a href=#reality-check>Reality Check</a></li></ul></nav></div><div class=post-content><div><div class=dialogue><p><span class="speaker speaker-management">Management:</span> We need better visibility into security events.</p><p><span class="speaker speaker-sysadmin">Sysadmin:</span> What are you currently monitoring?</p><p><span class="speaker speaker-management">Management:</span> Service uptime. CPU. Memory. The usual.</p><p><span class="speaker speaker-sysadmin">Sysadmin:</span> What about failed logins? Unexpected services? File changes?</p><p><span class="speaker speaker-management">Management:</span> That&rsquo;s what the SIEM is for.</p><p><span class="speaker speaker-sysadmin">Sysadmin:</span> When did you last look at the SIEM?</p><p><span class="speaker speaker-management">Management:</span> &mldr;</p></div><p>This is the problem with security monitoring. Teams spend thousands on SIEMs that nobody uses. Meanwhile, Prometheus sits there collecting metrics, and nobody thinks to point it at security problems.</p><aside class=pullquote>"Security monitoring doesn't need a six-figure SIEM budget. It needs metrics that matter, alerts that fire when something's actually wrong, and people who respond when they do."</aside><p>Prometheus is already in your infrastructure. It&rsquo;s collecting metrics. It&rsquo;s generating alerts. You just need to point it at the right things.</p><h2 id=why-prometheus-for-security-monitoring>Why Prometheus for Security Monitoring<a href=#why-prometheus-for-security-monitoring class=hanchor arialabel=Anchor>#</a></h2><p>Most people use Prometheus for service health. Application performance. Infrastructure capacity. It&rsquo;s time-series data. Simple metrics. Basic alerting.</p><p>Which is exactly what security monitoring needs.</p><p><strong>What security needs:</strong></p><ul><li>Real-time visibility (Prometheus scrapes every 15-60 seconds)</li><li>Lightweight collection (doesn&rsquo;t hammer systems or network)</li><li>Custom metrics (instrument whatever matters in your environment)</li><li>Alerting that works (alert when thresholds breach, not on keyword matches)</li><li>Linux-native (works everywhere, no agent hell)</li></ul><p><strong>What security doesn&rsquo;t need:</strong></p><ul><li>Complex correlation engines</li><li>Six-month queries</li><li>Compliance reports</li><li>Query languages that require training</li><li>License costs per GB ingested</li></ul><p>Prometheus gives you fast feedback on specific security indicators. Not forensics. Not compliance. Just &ldquo;is this thing happening right now that shouldn&rsquo;t be?&rdquo;</p><h2 id=the-cases-where-it-works>The Cases Where It Works<a href=#the-cases-where-it-works class=hanchor arialabel=Anchor>#</a></h2><h3 id=ssh-brute-force-detection>SSH Brute Force Detection<a href=#ssh-brute-force-detection class=hanchor arialabel=Anchor>#</a></h3><p>Public-facing SSH endpoints get hammered constantly. Some attacks are slow. Some are distributed. Traditional fail2ban works for obvious attacks but misses the subtle ones.</p><p>Monitor failed SSH attempts as a metric. Alert on rate of change.</p><p><strong>Custom exporter (Python):</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env python3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> prometheus_client <span style=color:#f92672>import</span> start_http_server, Counter
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> subprocess
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>FAILED_SSH <span style=color:#f92672>=</span> Counter(<span style=color:#e6db74>&#39;ssh_failed_attempts_total&#39;</span>, 
</span></span><span style=display:flex><span>                     <span style=color:#e6db74>&#39;Total failed SSH authentication attempts&#39;</span>,
</span></span><span style=display:flex><span>                     [<span style=color:#e6db74>&#39;user&#39;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_failed_attempts</span>():
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;Parse auth.log for failed attempts by user&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> subprocess<span style=color:#f92672>.</span>run(
</span></span><span style=display:flex><span>        [<span style=color:#e6db74>&#34;grep&#34;</span>, <span style=color:#e6db74>&#34;Failed password&#34;</span>, <span style=color:#e6db74>&#34;/var/log/auth.log&#34;</span>],
</span></span><span style=display:flex><span>        capture_output<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, text<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    attempts <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> line <span style=color:#f92672>in</span> result<span style=color:#f92672>.</span>stdout<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;for&#39;</span> <span style=color:#f92672>in</span> line <span style=color:#f92672>and</span> <span style=color:#e6db74>&#39;from&#39;</span> <span style=color:#f92672>in</span> line:
</span></span><span style=display:flex><span>            <span style=color:#75715e># Extract username</span>
</span></span><span style=display:flex><span>            user <span style=color:#f92672>=</span> line<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;for &#39;</span>)[<span style=color:#ae81ff>1</span>]<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39; from&#39;</span>)[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>            attempts[user] <span style=color:#f92672>=</span> attempts<span style=color:#f92672>.</span>get(user, <span style=color:#ae81ff>0</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> attempts
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>LAST_COUNTS <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>update_metrics</span>():
</span></span><span style=display:flex><span>    attempts <span style=color:#f92672>=</span> get_failed_attempts()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> user, count <span style=color:#f92672>in</span> attempts<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>        prev <span style=color:#f92672>=</span> LAST_COUNTS<span style=color:#f92672>.</span>get(user, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> count <span style=color:#f92672>&gt;</span> prev:
</span></span><span style=display:flex><span>            FAILED_SSH<span style=color:#f92672>.</span>labels(user<span style=color:#f92672>=</span>user)<span style=color:#f92672>.</span>inc(count <span style=color:#f92672>-</span> prev)
</span></span><span style=display:flex><span>        LAST_COUNTS[user] <span style=color:#f92672>=</span> count
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    start_http_server(<span style=color:#ae81ff>9101</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        update_metrics()
</span></span><span style=display:flex><span>        time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>60</span>)
</span></span></code></pre></div><p><strong>Prometheus scrape config:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>scrape_configs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>job_name</span>: <span style=color:#e6db74>&#39;ssh_security&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>static_configs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>targets</span>: [<span style=color:#e6db74>&#39;host1:9101&#39;</span>, <span style=color:#e6db74>&#39;host2:9101&#39;</span>, <span style=color:#e6db74>&#39;host3:9101&#39;</span>]
</span></span></code></pre></div><p><strong>Alert rule:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>groups</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ssh_security</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>alert</span>: <span style=color:#ae81ff>SSHBruteForce</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>expr</span>: <span style=color:#ae81ff>increase(ssh_failed_attempts_total[10m]) &gt; 10</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>for</span>: <span style=color:#ae81ff>5m</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>severity</span>: <span style=color:#ae81ff>warning</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>summary</span>: <span style=color:#e6db74>&#34;SSH brute force detected on {{ $labels.instance }}&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#34;{{ $value }} failed attempts in 10 minutes for user {{ $labels.user }}&#34;</span>
</span></span></code></pre></div><p>This catches slow attacks that fail2ban misses. Distributed attacks from multiple sources. Credential stuffing attempts.</p><p><strong>What you get:</strong></p><ul><li>Alert when attack rate changes (not just absolute counts)</li><li>Per-user visibility (see which accounts are targeted)</li><li>Historical trends (identify attack campaigns)</li><li>No log parsing overhead (metrics are aggregated)</li></ul><h3 id=cicd-pipeline-security>CI/CD Pipeline Security<a href=#cicd-pipeline-security class=hanchor arialabel=Anchor>#</a></h3><p>Build servers run with elevated permissions. Access to secrets. Ability to deploy to production. Perfect target.</p><p>Most teams monitor pipeline success rates and build times. Nobody monitors the security posture of the runners themselves.</p><p><strong>What to monitor:</strong></p><ul><li>Unexpected systemd services (persistence mechanisms)</li><li>New user accounts (backdoor access)</li><li>Unusual network connections (data exfiltration)</li><li>File system changes in sensitive directories</li><li>Resource spikes (cryptomining)</li></ul><p><strong>Bash exporter for suspicious services:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e># /usr/local/bin/pipeline-security-exporter.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74># HELP pipeline_suspicious_services Number of suspicious systemd services
</span></span></span><span style=display:flex><span><span style=color:#e6db74># TYPE pipeline_suspicious_services gauge
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># List of service patterns that shouldn&#39;t exist on build servers</span>
</span></span><span style=display:flex><span>SUSPICIOUS_PATTERNS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;nc\.service|ncat\.service|socat\.service|reverse.*\.service|backdoor.*\.service&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>COUNT<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>systemctl list-units --type<span style=color:#f92672>=</span>service --all | grep -E <span style=color:#e6db74>&#34;</span>$SUSPICIOUS_PATTERNS<span style=color:#e6db74>&#34;</span> | wc -l<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;pipeline_suspicious_services </span>$COUNT<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Check for new users created during pipeline runs</span>
</span></span><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74># HELP pipeline_unexpected_users Number of user accounts created today
</span></span></span><span style=display:flex><span><span style=color:#e6db74># TYPE pipeline_unexpected_users gauge
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Assuming clean runners start fresh, any new users are suspicious</span>
</span></span><span style=display:flex><span>BASELINE_USERS<span style=color:#f92672>=</span><span style=color:#ae81ff>50</span>  <span style=color:#75715e># Adjust for your environment</span>
</span></span><span style=display:flex><span>CURRENT_USERS<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>cat /etc/passwd | wc -l<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>NEW_USERS<span style=color:#f92672>=</span><span style=color:#66d9ef>$((</span>CURRENT_USERS <span style=color:#f92672>-</span> BASELINE_USERS<span style=color:#66d9ef>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> $NEW_USERS -lt <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    NEW_USERS<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;pipeline_unexpected_users </span>$NEW_USERS<span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><p><strong>Deploy as textfile collector:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Run script every minute via cron</span>
</span></span><span style=display:flex><span>* * * * * /usr/local/bin/pipeline-security-exporter.sh &gt; /var/lib/node_exporter/textfile_collector/pipeline_security.prom
</span></span></code></pre></div><p><strong>Alert on any non-zero values:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>alert</span>: <span style=color:#ae81ff>PipelineSuspiciousServices</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>expr</span>: <span style=color:#ae81ff>pipeline_suspicious_services &gt; 0</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>for</span>: <span style=color:#ae81ff>0m </span> <span style=color:#75715e># Alert immediately</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>severity</span>: <span style=color:#ae81ff>critical</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>summary</span>: <span style=color:#e6db74>&#34;Suspicious systemd services on {{ $labels.instance }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#34;Found {{ $value }} suspicious services&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>alert</span>: <span style=color:#ae81ff>PipelineUnexpectedUsers</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>expr</span>: <span style=color:#ae81ff>pipeline_unexpected_users &gt; 0</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>for</span>: <span style=color:#ae81ff>0m </span> <span style=color:#75715e># Alert immediately</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>severity</span>: <span style=color:#ae81ff>critical</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>summary</span>: <span style=color:#e6db74>&#34;Unexpected user accounts on {{ $labels.instance }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#34;Found {{ $value }} new user accounts (baseline mismatch)&#34;</span>
</span></span></code></pre></div><p><strong>Reality check:</strong></p><p>This won&rsquo;t catch sophisticated attackers who clean up after themselves. But it catches:</p><ul><li>Script kiddies who install netcat services</li><li>Supply chain attacks that add persistence</li><li>Compromised dependencies that create user accounts</li><li>Cryptominers that install systemd services</li></ul><p>Most attacks aren&rsquo;t sophisticated. Most are opportunistic. This catches the opportunistic ones.</p><h3 id=file-integrity-monitoring>File Integrity Monitoring<a href=#file-integrity-monitoring class=hanchor arialabel=Anchor>#</a></h3><p>Commercial FIM solutions cost money and add agent overhead. Prometheus can do basic FIM with a shell script.</p><p><strong>What to monitor:</strong></p><ul><li><code>/etc/passwd</code> and <code>/etc/shadow</code> (user accounts)</li><li><code>/etc/sudoers</code> (privilege escalation)</li><li>SSH authorized_keys files</li><li>Cron directories (<code>/etc/cron.*</code>)</li><li>Systemd service files</li><li>Application configuration files with secrets</li></ul><p><strong>Exporter approach:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e># /usr/local/bin/fim-exporter.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74># HELP fim_checksum_numeric Numeric representation of file checksum for change detection
</span></span></span><span style=display:flex><span><span style=color:#e6db74># TYPE fim_checksum_numeric gauge
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Files to monitor</span>
</span></span><span style=display:flex><span>FILES<span style=color:#f92672>=(</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;/etc/passwd&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;/etc/shadow&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;/etc/sudoers&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;/etc/ssh/sshd_config&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;/root/.ssh/authorized_keys&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> file in <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>FILES[@]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -f <span style=color:#e6db74>&#34;</span>$file<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Get SHA256 hash and convert to decimal for Prometheus</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Take first 16 chars of hex (fits in 64-bit float)</span>
</span></span><span style=display:flex><span>        hash<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>sha256sum <span style=color:#e6db74>&#34;</span>$file<span style=color:#e6db74>&#34;</span> | cut -d<span style=color:#e6db74>&#39; &#39;</span> -f1 | cut -c1-16<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>        decimal<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo <span style=color:#e6db74>&#34;ibase=16; </span><span style=color:#66d9ef>$(</span>echo $hash | tr a-f A-F<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> | bc<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># Sanitize filename for label</span>
</span></span><span style=display:flex><span>        label<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo <span style=color:#e6db74>&#34;</span>$file<span style=color:#e6db74>&#34;</span> | sed <span style=color:#e6db74>&#39;s/\//_/g&#39;</span> | sed <span style=color:#e6db74>&#39;s/^_//&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;fim_checksum_numeric{file=\&#34;</span>$file<span style=color:#e6db74>\&#34;} </span>$decimal<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span></code></pre></div><p><strong>Alert on any change:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>alert</span>: <span style=color:#ae81ff>CriticalFileModified</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>expr</span>: <span style=color:#ae81ff>changes(fim_checksum_numeric[5m]) &gt; 0</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>for</span>: <span style=color:#ae81ff>0m</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>severity</span>: <span style=color:#ae81ff>critical</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>summary</span>: <span style=color:#e6db74>&#34;Critical file modified on {{ $labels.instance }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#34;File {{ $labels.file }} has been modified&#34;</span>
</span></span></code></pre></div><p><strong>Limitations:</strong></p><p>This is simple change detection. It doesn&rsquo;t tell you what changed or who changed it. It just tells you it changed.</p><p>For critical systems, that&rsquo;s often enough. You shouldn&rsquo;t be changing <code>/etc/shadow</code> on production systems. If it changes, investigate.</p><p>For systems with legitimate changes, this generates noise. Use it where files genuinely shouldn&rsquo;t change.</p><h3 id=container-security-monitoring>Container Security Monitoring<a href=#container-security-monitoring class=hanchor arialabel=Anchor>#</a></h3><p>If you&rsquo;re running Kubernetes, you&rsquo;re probably already using Prometheus. You&rsquo;re monitoring pods, deployments, resource usage.</p><p>Are you monitoring security events?</p><p><strong>Metrics to collect:</strong></p><ul><li>Containers running as root (most shouldn&rsquo;t be)</li><li>Containers with privileged mode (very few should be)</li><li>Containers mounting sensitive host paths</li><li>Image pull failures (supply chain visibility)</li><li>Security context violations</li></ul><p>Most of this comes from kube-state-metrics. You just need to alert on it.</p><p><strong>Alert on privileged containers:</strong></p><p>kube-state-metrics exposes <code>kube_pod_spec_containers_security_context_privileged</code> (value 1 if privileged). Join it with running status:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>alert</span>: <span style=color:#ae81ff>PrivilegedContainer</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>expr</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    kube_pod_container_status_running{container!=&#34;&#34;} == 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    and on(namespace, pod, container)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    kube_pod_spec_containers_security_context_privileged == 1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>for</span>: <span style=color:#ae81ff>5m</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>severity</span>: <span style=color:#ae81ff>warning</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>summary</span>: <span style=color:#e6db74>&#34;Privileged container running in {{ $labels.namespace }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#34;Container {{ $labels.container }} in pod {{ $labels.pod }} is running with privileged mode&#34;</span>
</span></span></code></pre></div><p><strong>Alert on containers running as root:</strong></p><p>kube-state-metrics exposes <code>kube_pod_spec_containers_security_context_run_as_user</code>. Alert when it&rsquo;s 0 (root):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>alert</span>: <span style=color:#ae81ff>ContainerRunningAsRoot</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>expr</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    kube_pod_container_status_running{container!=&#34;&#34;} == 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    and on(namespace, pod, container)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    kube_pod_spec_containers_security_context_run_as_user == 0</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>for</span>: <span style=color:#ae81ff>5m</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>severity</span>: <span style=color:#ae81ff>info</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>summary</span>: <span style=color:#e6db74>&#34;Container running as root in {{ $labels.namespace }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#34;Container {{ $labels.container }} in pod {{ $labels.pod }} is running as UID 0&#34;</span>
</span></span></code></pre></div><p>Note: not every pod sets <code>runAsUser</code> explicitly. If the field is absent, kube-state-metrics won&rsquo;t emit the metric at all, so this alert only catches pods that explicitly set <code>runAsUser: 0</code>. For broader coverage, combine with an OPA/Kyverno admission policy that requires <code>runAsNonRoot: true</code>.</p><p>These aren&rsquo;t always problems. Some workloads legitimately need privileges. But you should know which ones and alert when unexpected ones appear.</p><h3 id=dns-exfiltration-detection>DNS Exfiltration Detection<a href=#dns-exfiltration-detection class=hanchor arialabel=Anchor>#</a></h3><p>DNS tunneling is common for data exfiltration and C2 communication. High volume of DNS queries to unusual domains is a strong indicator.</p><p>If you&rsquo;re using CoreDNS in Kubernetes, it already exports Prometheus metrics.</p><p><strong>Alert on DNS query spikes:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>alert</span>: <span style=color:#ae81ff>DNSQuerySpike</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>expr</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    rate(coredns_dns_requests_total[5m]) &gt; 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    avg_over_time(rate(coredns_dns_requests_total[5m])[1h:]) * 5</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>for</span>: <span style=color:#ae81ff>10m</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>severity</span>: <span style=color:#ae81ff>warning</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>summary</span>: <span style=color:#e6db74>&#34;DNS query spike detected on {{ $labels.instance }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#34;DNS queries are 5x higher than normal average&#34;</span>
</span></span></code></pre></div><p><strong>Alert on NXDOMAIN spike (common exfiltration signal):</strong></p><p>CoreDNS exports response codes. A sudden spike in NXDOMAIN responses often indicates tunnelling (lots of unique subdomains) or a misconfigured service:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>alert</span>: <span style=color:#ae81ff>DNSNXDomainSpike</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>expr</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    rate(coredns_dns_responses_total{rcode=&#34;NXDOMAIN&#34;}[5m])
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    / rate(coredns_dns_responses_total[5m]) &gt; 0.15</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>for</span>: <span style=color:#ae81ff>10m</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>severity</span>: <span style=color:#ae81ff>warning</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>summary</span>: <span style=color:#e6db74>&#34;High NXDOMAIN rate on {{ $labels.instance }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#34;NXDOMAIN responses are {{ $value | humanizePercentage }} of all DNS responses&#34;</span>
</span></span></code></pre></div><p>Note: CoreDNS metrics track queries by zone and response code, not by queried domain name. If you need per-domain visibility (e.g. &ldquo;which client queried which domain&rdquo;), you need DNS query logging (CoreDNS <code>log</code> plugin) piped into a log aggregator, not Prometheus.</p><p>These alerts won&rsquo;t catch sophisticated tunnelling. But they catch:</p><ul><li>Obvious tunneling tools (dnscat2, iodine)</li><li>Malware using DNS for C2</li><li>Data exfiltration via DNS queries</li></ul><h2 id=what-prometheus-doesnt-do>What Prometheus Doesn&rsquo;t Do<a href=#what-prometheus-doesnt-do class=hanchor arialabel=Anchor>#</a></h2><p>Be realistic about limitations.</p><p><strong>Prometheus is not:</strong></p><ul><li>A SIEM (no long-term log storage, no correlation engine)</li><li>Forensics tool (metrics are aggregated, not raw events)</li><li>Compliance solution (no audit trail of who accessed what)</li><li>Threat intelligence platform (no IOC feeds, no reputation data)</li><li>DLP solution (no content inspection)</li></ul><p><strong>Prometheus is:</strong></p><ul><li>Real-time monitoring of specific indicators</li><li>Fast alerting when thresholds breach</li><li>Trend analysis over hours/days</li><li>Lightweight collection that doesn&rsquo;t kill systems</li></ul><p>Use it for what it&rsquo;s good at. Don&rsquo;t try to make it do everything.</p><h2 id=making-alerts-useful>Making Alerts Useful<a href=#making-alerts-useful class=hanchor arialabel=Anchor>#</a></h2><p>Security alerts are worthless if nobody responds to them.</p><p><strong>Alert rules:</strong></p><ol><li><strong>Critical alerts go to pagers</strong> - File integrity changes, privileged containers, pipeline compromise</li><li><strong>Warning alerts go to Slack</strong> - SSH attacks, DNS spikes, unusual activity</li><li><strong>Info alerts go to dashboards</strong> - Trends, baselines, context</li></ol><p><strong>Alert fatigue is real:</strong></p><ul><li>Start with low-sensitivity rules</li><li>Tune thresholds based on actual environment</li><li>Disable alerts that fire constantly</li><li>Don&rsquo;t alert on things you can&rsquo;t act on</li></ul><div class=dialogue><p><span class="speaker speaker-engineer">Engineer:</span> We&rsquo;re getting 50 SSH alerts per hour.</p><p><span class="speaker speaker-sysadmin">Sysadmin:</span> Are you responding to them?</p><p><span class="speaker speaker-engineer">Engineer:</span> No, they&rsquo;re all background noise from Chinese IPs.</p><p><span class="speaker speaker-sysadmin">Sysadmin:</span> Then why are you alerting on them?</p><p><span class="speaker speaker-engineer">Engineer:</span> Security said we need visibility.</p><p><span class="speaker speaker-sysadmin">Sysadmin:</span> Visibility means dashboards. Alerts mean &ldquo;do something now.&rdquo; If you&rsquo;re not doing something, turn off the alert.</p></div><p>Dashboard the trends. Alert on deviations. Don&rsquo;t alert on normal internet background radiation.</p><h2 id=securing-prometheus-itself>Securing Prometheus Itself<a href=#securing-prometheus-itself class=hanchor arialabel=Anchor>#</a></h2><p>Prometheus tells you what is running where. That&rsquo;s why it&rsquo;s useful.</p><p>It&rsquo;s also why you should treat it like an internal admin interface.</p><p>If an attacker can query Prometheus, they can:</p><ul><li>Map your estate (hostnames, pods, namespaces, container names)</li><li>Pull versions (kernel, runtimes, sometimes app versions)</li><li>Find juicy targets (databases, CI runners, bastions)</li><li>See what you&rsquo;re already alerting on (and work around it)</li></ul><h3 id=keep-it-private>Keep It Private<a href=#keep-it-private class=hanchor arialabel=Anchor>#</a></h3><p>Prometheus and exporters should not be public. Not even &ldquo;just for a bit&rdquo;.</p><p>On a VM, bind Prometheus to localhost and only expose it through a private reverse proxy / VPN:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#75715e># /etc/systemd/system/prometheus.service (snippet)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Service]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/local/bin/prometheus \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  --config.file=/etc/prometheus/prometheus.yml \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  --storage.tsdb.path=/var/lib/prometheus \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  --web.listen-address=127.0.0.1:9090</span>
</span></span></code></pre></div><p>On Kubernetes, make it a ClusterIP service and put authentication on the Ingress. Add NetworkPolicies so only Grafana and other trusted things can talk to it.</p><h3 id=add-authentication-prometheus-doesnt-do-this-for-you>Add Authentication (Prometheus Doesn&rsquo;t Do This For You)<a href=#add-authentication-prometheus-doesnt-do-this-for-you class=hanchor arialabel=Anchor>#</a></h3><p>Prometheus doesn&rsquo;t have built-in auth. Put a reverse proxy in front of it.</p><p>Simple option: Caddy with basic auth (fine for a small team behind a VPN):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-caddyfile data-lang=caddyfile><span style=display:flex><span>prom.example.internal {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>encode</span> <span style=color:#e6db74>zstd</span> <span style=color:#e6db74>gzip</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>basicauth</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>gareth</span> <span style=color:#e6db74>$2a$12$REPLACE_WITH_BCRYPT_HASH</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>reverse_proxy</span> 127.0.0.1:<span style=color:#ae81ff>9090</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Generate the bcrypt hash with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span>caddy hash-password --plaintext <span style=color:#e6db74>&#39;choose-a-real-password&#39;</span>
</span></span></code></pre></div><p>If you&rsquo;re already using SSO, put OIDC in front (oauth2-proxy, nginx auth_request, whatever you already run). The big win isn&rsquo;t the tool - it&rsquo;s having some identity boundary and logs.</p><h3 id=use-tls-for-scrapes-or-keep-scrapes-on-a-trusted-network>Use TLS For Scrapes (Or Keep Scrapes On A Trusted Network)<a href=#use-tls-for-scrapes-or-keep-scrapes-on-a-trusted-network class=hanchor arialabel=Anchor>#</a></h3><p>If Prometheus scrapes over networks you don&rsquo;t control, use TLS. Most exporters support this via <code>--web.config.file</code>.</p><p>Example scrape config with TLS:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>scrape_configs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>job_name</span>: <span style=color:#ae81ff>node</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>scheme</span>: <span style=color:#ae81ff>https</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>static_configs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>targets</span>: [<span style=color:#e6db74>&#39;node1.internal:9100&#39;</span>, <span style=color:#e6db74>&#39;node2.internal:9100&#39;</span>]
</span></span><span style=display:flex><span>    <span style=color:#f92672>tls_config</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>ca_file</span>: <span style=color:#ae81ff>/etc/prometheus/pki/ca.crt</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>server_name</span>: <span style=color:#ae81ff>node-exporter.internal</span>
</span></span></code></pre></div><p>If you don&rsquo;t want to deal with TLS on every exporter, keep scrapes on a private network segment and firewall it properly.</p><h3 id=treat-exporters-like-attack-surface>Treat Exporters Like Attack Surface<a href=#treat-exporters-like-attack-surface class=hanchor arialabel=Anchor>#</a></h3><p><code>node_exporter</code> is basically &ldquo;tell me about this box&rdquo; on port 9100. Keep it private too.</p><p>If you must expose an exporter, put it behind TLS/auth or a tunnel. Don&rsquo;t leave it on the internet and hope nobody notices.</p><h3 id=dont-leak-secrets-into-labels>Don&rsquo;t Leak Secrets Into Labels<a href=#dont-leak-secrets-into-labels class=hanchor arialabel=Anchor>#</a></h3><p>Metric labels get stored in plaintext. Forever (or at least until retention expires).</p><p>Don&rsquo;t put:</p><ul><li>Passwords, tokens, API keys</li><li>Session IDs</li><li>Email addresses / customer IDs</li></ul><p>For custom exporters: treat label values as public. If you need detail, emit a count and send the raw event to logs.</p><h3 id=lock-down-grafana-too>Lock Down Grafana Too<a href=#lock-down-grafana-too class=hanchor arialabel=Anchor>#</a></h3><p>Grafana is where people actually browse this stuff.</p><p>Use teams/folders and restrict access to security dashboards. Not because developers are malicious - because &ldquo;everyone can see everything&rdquo; turns into screenshots pasted into tickets, Slack, and vendor calls.</p><h3 id=common-mistakes>Common Mistakes<a href=#common-mistakes class=hanchor arialabel=Anchor>#</a></h3><p>Exposing <code>node_exporter</code> on the public internet. Running Prometheus with no auth. Turning on admin endpoints (<code>--web.enable-admin-api</code>, <code>--web.enable-lifecycle</code>) and forgetting they&rsquo;re there. Putting secrets in metric labels. Giving everyone access to everything because it&rsquo;s easier.</p><h2 id=when-to-use-something-else>When to Use Something Else<a href=#when-to-use-something-else class=hanchor arialabel=Anchor>#</a></h2><p>Prometheus isn&rsquo;t the answer to everything.</p><p><strong>Use a proper SIEM when:</strong></p><ul><li>Compliance requires it (PCI-DSS, HIPAA, etc.)</li><li>You need long-term retention (years, not weeks)</li><li>You need complex correlation (multiple data sources)</li><li>You need audit trails (who accessed what when)</li></ul><p><strong>Use dedicated security tools when:</strong></p><ul><li>You need threat intelligence integration</li><li>You need automated response (SOAR)</li><li>You need deep packet inspection</li><li>You need endpoint forensics</li></ul><p><strong>Use Prometheus when:</strong></p><ul><li>You need fast feedback on specific indicators</li><li>You have custom metrics that matter in your environment</li><li>You want lightweight monitoring without agent hell</li><li>You&rsquo;re already using Prometheus for other things</li></ul><p>Don&rsquo;t replace everything with Prometheus. Add security metrics to what you&rsquo;re already collecting.</p><h2 id=getting-started>Getting Started<a href=#getting-started class=hanchor arialabel=Anchor>#</a></h2><p>Start small. Add one security metric. See if it&rsquo;s useful. Add another.</p><p><strong>Week 1:</strong> Monitor SSH failed logins on public-facing systems. See what normal looks like. Set a threshold. Alert when exceeded.</p><p><strong>Week 2:</strong> Add file integrity monitoring for critical files. See what changes and why. Reduce false positives.</p><p><strong>Week 3:</strong> Add container security metrics. Find containers that shouldn&rsquo;t be privileged. Fix them or whitelist them.</p><p><strong>Week 4:</strong> Add custom metrics for your environment. What matters? What changes indicate problems?</p><p>Don&rsquo;t try to monitor everything. Monitor what matters. Alert on what&rsquo;s actionable.</p><h2 id=reality-check>Reality Check<a href=#reality-check class=hanchor arialabel=Anchor>#</a></h2><p>This approach won&rsquo;t catch advanced persistent threats. Won&rsquo;t detect zero-days. Won&rsquo;t stop nation-state actors.</p><p>It will catch:</p><ul><li>Script kiddies</li><li>Opportunistic attacks</li><li>Compromised credentials</li><li>Insider mistakes</li><li>Misconfigurations</li><li>Supply chain compromises</li></ul><p>Most breaches aren&rsquo;t sophisticated. Most are basic attacks that succeed because nobody was watching.</p><p>Prometheus helps you watch.</p><p>Not everything. Not perfectly. But the things that matter, in real time, with alerts that fire when they should.</p><p>Which is better than a SIEM nobody looks at.</p></div></div><div class=related-posts style="margin-top:3rem;padding-top:2rem;border-top:1px solid #333"><h3>Related Posts</h3><ul style=list-style:none;padding:0><li style=margin-bottom:1rem><a href=https://gazsecops.github.io/posts/dns-security-what-actually-breaks/>DNS Security: What Actually Breaks</a>
<span style=color:#999;font-size:.9rem>- 12 Jun 2025</span><div style=font-size:.85rem;color:#666;margin-top:.25rem><span style=margin-right:.5rem>#security</span>
<span style=margin-right:.5rem>#dns</span>
<span style=margin-right:.5rem>#linux</span>
<span style=margin-right:.5rem>#cloud</span>
<span style=margin-right:.5rem>#monitoring</span>
<span style=margin-right:.5rem>#operations</span>
<span style=margin-right:.5rem>#incident-response</span></div></li><li style=margin-bottom:1rem><a href=https://gazsecops.github.io/posts/bash-security-operators-guide/>Bash: The Swiss Army Knife for Security Professionals</a>
<span style=color:#999;font-size:.9rem>- 3 Dec 2024</span><div style=font-size:.85rem;color:#666;margin-top:.25rem><span style=margin-right:.5rem>#bash</span>
<span style=margin-right:.5rem>#security</span>
<span style=margin-right:.5rem>#red-team</span>
<span style=margin-right:.5rem>#blue-team</span>
<span style=margin-right:.5rem>#linux</span>
<span style=margin-right:.5rem>#operations</span></div></li><li style=margin-bottom:1rem><a href=https://gazsecops.github.io/posts/stepca-running-internal-pki/>Smallstep step-ca: Running Internal PKI Without Losing Your Mind</a>
<span style=color:#999;font-size:.9rem>- 28 Oct 2025</span><div style=font-size:.85rem;color:#666;margin-top:.25rem><span style=margin-right:.5rem>#security</span>
<span style=margin-right:.5rem>#pki</span>
<span style=margin-right:.5rem>#tls</span>
<span style=margin-right:.5rem>#certificates</span>
<span style=margin-right:.5rem>#linux</span>
<span style=margin-right:.5rem>#cloud</span>
<span style=margin-right:.5rem>#operations</span></div></li><li style=margin-bottom:1rem><a href=https://gazsecops.github.io/posts/incident-response-what-actually-works/>Incident Response: What Actually Works at 3am</a>
<span style=color:#999;font-size:.9rem>- 2 Jul 2025</span><div style=font-size:.85rem;color:#666;margin-top:.25rem><span style=margin-right:.5rem>#security</span>
<span style=margin-right:.5rem>#incident-response</span>
<span style=margin-right:.5rem>#operations</span>
<span style=margin-right:.5rem>#linux</span>
<span style=margin-right:.5rem>#cloud</span></div></li><li style=margin-bottom:1rem><a href=https://gazsecops.github.io/posts/password-managers-2025/>Password Managers in 2025: What Actually Works</a>
<span style=color:#999;font-size:.9rem>- 15 Apr 2025</span><div style=font-size:.85rem;color:#666;margin-top:.25rem><span style=margin-right:.5rem>#security</span>
<span style=margin-right:.5rem>#passwords</span>
<span style=margin-right:.5rem>#vault</span>
<span style=margin-right:.5rem>#linux</span>
<span style=margin-right:.5rem>#operations</span></div></li></ul></div><div class=pagination><div class=pagination__title><span class=pagination__title-h></span><hr></div><div class=pagination__buttons><a href=https://gazsecops.github.io/posts/canary-tokens-early-warning/ class="button inline prev">&lt; [<span class=button__text>Canary Tokens: Early Warning Systems That Actually Work</span>]</a></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>Â© 2026</span></div><div class=build-info><span class=build-commit>e733073</span><span class=build-date>2026-02-12 12:33 UTC</span></div></div></footer></div></body></html>