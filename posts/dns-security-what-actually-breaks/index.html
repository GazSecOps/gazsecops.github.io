<!doctype html><html lang=en><head><title>DNS Security: What Actually Breaks :: Gareth's Engineering Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content=" On-call: The website is down.
Management: But the servers are fine. CPU is low. No errors.
Sysadmin: Your DNS records point at last week&rsquo;s IP.
Management: DNS is just a phone book. How can that take us down?
Sysadmin: Because your whole company uses it as the source of truth, whether you admit it or not.
DNS is the most boring critical system you run. Nobody thinks about it until it fails, and when it fails everyone suddenly becomes very interested in TTLs.
You can patch servers. You can roll back deployments. You can add more replicas. None of that matters if clients can&rsquo;t resolve names.
DNS security isn&rsquo;t &ldquo;do DNSSEC and you&rsquo;re done&rdquo;. It&rsquo;s availability, integrity, and watching the bits that attackers like because you usually leave them alone.
DNS isn't a phone book. It's a control plane. This post covers how DNS breaks in the real world, how attackers use it, what you can monitor without buying a new platform, and what to do at 3am when name resolution goes sideways.
"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://gazsecops.github.io/posts/dns-security-what-actually-breaks/><link rel=stylesheet href=https://gazsecops.github.io/css/extended.min.c658c723e006469d82f697e19c5338967fad12c57650bdd915bacf9cfbe2cc38.css><link rel=stylesheet href=https://gazsecops.github.io/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css><link rel=stylesheet href=https://gazsecops.github.io/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css><link rel=stylesheet href=https://gazsecops.github.io/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css><link rel=stylesheet href=https://gazsecops.github.io/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css><link rel=stylesheet href=https://gazsecops.github.io/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css><link rel=stylesheet href=https://gazsecops.github.io/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css><link rel=stylesheet href=https://gazsecops.github.io/css/main.min.36833afd348409fc6c3d09d0897c5833d9d5bf1ff31f5e60ea3ee42ce2b1268c.css><link rel=stylesheet href=https://gazsecops.github.io/css/menu.min.3c17467ebeb3d38663dce68f71f519901124fa5cbb4519b2fb0667a21e9aca39.css><link rel=stylesheet href=https://gazsecops.github.io/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css><link rel=stylesheet href=https://gazsecops.github.io/css/post.min.e6dddd258e64c83e05cec0cd49c05216742d42fc8ecbfbe6b67083412b609bd3.css><link rel=stylesheet href=https://gazsecops.github.io/css/syntax.min.a0773cce9310cb6d8ed23e50f005448facf29a53001b57e038828daa466b25c0.css><link rel=stylesheet href=https://gazsecops.github.io/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css><link rel=stylesheet href=https://gazsecops.github.io/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css><link rel="shortcut icon" href=https://gazsecops.github.io/favicon.png><link rel=apple-touch-icon href=https://gazsecops.github.io/apple-touch-icon.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="DNS Security: What Actually Breaks"><meta property="og:description" content=" On-call: The website is down.
Management: But the servers are fine. CPU is low. No errors.
Sysadmin: Your DNS records point at last week&rsquo;s IP.
Management: DNS is just a phone book. How can that take us down?
Sysadmin: Because your whole company uses it as the source of truth, whether you admit it or not.
DNS is the most boring critical system you run. Nobody thinks about it until it fails, and when it fails everyone suddenly becomes very interested in TTLs.
You can patch servers. You can roll back deployments. You can add more replicas. None of that matters if clients can&rsquo;t resolve names.
DNS security isn&rsquo;t &ldquo;do DNSSEC and you&rsquo;re done&rdquo;. It&rsquo;s availability, integrity, and watching the bits that attackers like because you usually leave them alone.
DNS isn't a phone book. It's a control plane. This post covers how DNS breaks in the real world, how attackers use it, what you can monitor without buying a new platform, and what to do at 3am when name resolution goes sideways.
"><meta property="og:url" content="https://gazsecops.github.io/posts/dns-security-what-actually-breaks/"><meta property="og:site_name" content="Gareth's Engineering Blog"><meta property="og:image" content="https://gazsecops.github.io/og-image.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2025-06-12 10:00:00 +0000 UTC"></head><body><div class="container center"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>gareth@blog:~$</div></a></div><div class=header__search><input type=text id=header-search placeholder="Quick search..." style="padding:5px 10px;background:#222;color:#eee;border:1px solid #444;border-radius:3px;font-size:14px;width:200px"></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/topics/>Topics</a></li><li><a href=/posts/>All</a></li><li><a href=/series/>Series</a></li><li><a href=/tags/>Tags</a></li><li><a href=/archive/>Archive</a></li><li><a href=/search/>Search</a></li><li><a href=/about/>About</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/topics/>Topics</a></li><li><a href=/posts/>All</a></li><li><a href=/series/>Series</a></li><li><a href=/tags/>Tags</a></li><li><a href=/archive/>Archive</a></li><li><a href=/search/>Search</a></li><li><a href=/about/>About</a></li></ul></nav></header><script>(function(){const e=document.getElementById("header-search");if(!e)return;e.addEventListener("keydown",function(e){if(e.key==="Enter"){const e=this.value.trim();e&&(window.location.href="/search?q="+encodeURIComponent(e))}}),document.addEventListener("keydown",function(t){t.key==="/"&&!["INPUT","TEXTAREA"].includes(t.target.tagName)&&(t.preventDefault(),e.focus()),t.key==="Escape"&&t.target===e&&e.blur()})})()</script><style>.header__inner{display:flex;align-items:center;gap:20px}.header__search{flex:none}#header-search::placeholder{color:#666;font-style:italic}#header-search:focus{outline:none;border-color:#888}@media(max-width:684px){.header__search{display:none}}</style><div class=content><article class=post><h1 class=post-title><a href=https://gazsecops.github.io/posts/dns-security-what-actually-breaks/>DNS Security: What Actually Breaks</a></h1><div class=post-meta><time class=post-date>2025-06-12</time><span class=post-author>Gareth</span><span class=post-reading-time>10 min read (2006 words)</span></div><span class=post-tags>#<a href=https://gazsecops.github.io/tags/security/>security</a>&nbsp;
#<a href=https://gazsecops.github.io/tags/dns/>dns</a>&nbsp;
#<a href=https://gazsecops.github.io/tags/linux/>linux</a>&nbsp;
#<a href=https://gazsecops.github.io/tags/cloud/>cloud</a>&nbsp;
#<a href=https://gazsecops.github.io/tags/monitoring/>monitoring</a>&nbsp;
#<a href=https://gazsecops.github.io/tags/operations/>operations</a>&nbsp;
#<a href=https://gazsecops.github.io/tags/incident-response/>incident-response</a>&nbsp;</span><div class=table-of-contents><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#what-dns-actually-is-in-practice>What DNS Actually Is (In Practice)</a></li><li><a href=#the-linux-and-cloud-dns-stack-where-the-packets-go>The Linux and Cloud DNS Stack (Where the Packets Go)</a></li><li><a href=#how-dns-breaks-the-stuff-you-see-weekly>How DNS Breaks (The Stuff You See Weekly)</a><ul><li><a href=#1-wrong-record-wrong-ttl-wrong-place>1. Wrong record, wrong TTL, wrong place</a></li><li><a href=#2-resolver-problems-everything-looks-down>2. Resolver problems (everything looks down)</a></li><li><a href=#3-mtu-and-fragmentation-the-invisible-pain>3. MTU and fragmentation (the invisible pain)</a></li><li><a href=#4-split-horizon-and-private-zones-cloud-favourite>4. Split-horizon and private zones (cloud favourite)</a></li><li><a href=#5-kubernetes-dns-pain-ndots-search-paths-coredns>5. Kubernetes DNS pain (ndots, search paths, CoreDNS)</a></li></ul></li><li><a href=#how-attackers-use-dns>How Attackers Use DNS</a><ul><li><a href=#1-dns-as-a-beacon>1. DNS as a beacon</a></li><li><a href=#2-dns-tunnelling-and-exfiltration>2. DNS tunnelling and exfiltration</a></li><li><a href=#3-dns-spoofing-inside-your-network>3. DNS spoofing inside your network</a></li><li><a href=#4-domain-takeover-by-deletion>4. Domain takeover by deletion</a></li></ul></li><li><a href=#monitoring-that-actually-matters>Monitoring That Actually Matters</a><ul><li><a href=#service-metrics>Service metrics</a></li><li><a href=#behaviour-metrics>Behaviour metrics</a></li><li><a href=#collecting-dns-logs-without-losing-your-mind>Collecting DNS logs without losing your mind</a></li><li><a href=#cloud-dns-what-to-switch-on>Cloud DNS: what to switch on</a></li></ul></li><li><a href=#defences-that-work-and-dont-require-heroics>Defences That Work (And Don&rsquo;t Require Heroics)</a><ul><li><a href=#1-control-the-resolvers>1. Control the resolvers</a></li><li><a href=#2-use-rpz--dns-filtering-where-it-helps>2. Use RPZ / DNS filtering where it helps</a></li><li><a href=#3-dnssec-useful-but-not-a-magic-shield>3. DNSSEC: useful, but not a magic shield</a></li><li><a href=#4-dohdot-decide-what-you-want>4. DoH/DoT: decide what you want</a></li></ul></li><li><a href=#incident-response-dns-edition>Incident Response: DNS Edition</a><ul><li><a href=#1-confirm-its-dns-dont-guess>1. Confirm it&rsquo;s DNS (don&rsquo;t guess)</a></li><li><a href=#2-check-ttl-and-caching-reality>2. Check TTL and caching reality</a></li><li><a href=#3-look-for-servfail-timeouts-and-tcp-fallback>3. Look for SERVFAIL, timeouts, and TCP fallback</a></li><li><a href=#4-contain-and-stabilise>4. Contain and stabilise</a></li><li><a href=#5-hunt-the-cause>5. Hunt the cause</a></li></ul></li><li><a href=#the-boring-truth>The Boring Truth</a></li></ul></nav></div><div class=post-content><div><div class=dialogue><p><span class="speaker speaker-oncall">On-call:</span> The website is down.</p><p><span class="speaker speaker-management">Management:</span> But the servers are fine. CPU is low. No errors.</p><p><span class="speaker speaker-sysadmin">Sysadmin:</span> Your DNS records point at last week&rsquo;s IP.</p><p><span class="speaker speaker-management">Management:</span> DNS is just a phone book. How can that take us down?</p><p><span class="speaker speaker-sysadmin">Sysadmin:</span> Because your whole company uses it as the source of truth, whether you admit it or not.</p></div><p>DNS is the most boring critical system you run. Nobody thinks about it until it fails, and when it fails everyone suddenly becomes very interested in TTLs.</p><p>You can patch servers. You can roll back deployments. You can add more replicas. None of that matters if clients can&rsquo;t resolve names.</p><p>DNS security isn&rsquo;t &ldquo;do DNSSEC and you&rsquo;re done&rdquo;. It&rsquo;s availability, integrity, and watching the bits that attackers like because you usually leave them alone.</p><aside class=pullquote>DNS isn't a phone book. It's a control plane.</aside><p>This post covers how DNS breaks in the real world, how attackers use it, what you can monitor without buying a new platform, and what to do at 3am when name resolution goes sideways.</p><h2 id=what-dns-actually-is-in-practice>What DNS Actually Is (In Practice)<a href=#what-dns-actually-is-in-practice class=hanchor arialabel=Anchor>#</a></h2><p>On paper, DNS maps names to IPs.</p><p>In practice, DNS is:</p><ul><li>How your clients find everything (apps, APIs, identity, updates, email)</li><li>A policy point (blocklists, allowlists, split-horizon)</li><li>A dependency for other dependencies (PKI, OAuth redirects, package repos)</li><li>A place attackers hide (because port 53 is usually allowed out)</li></ul><p>Also: caching means &ldquo;we fixed it&rdquo; and &ldquo;users still see it broken&rdquo; can both be true at the same time.</p><h2 id=the-linux-and-cloud-dns-stack-where-the-packets-go>The Linux and Cloud DNS Stack (Where the Packets Go)<a href=#the-linux-and-cloud-dns-stack-where-the-packets-go class=hanchor arialabel=Anchor>#</a></h2><p>If you&rsquo;re running Linux and cloud workloads, you don&rsquo;t have &ldquo;DNS&rdquo;. You have layers:</p><ul><li>Application calls <code>getaddrinfo()</code> (or does its own thing)</li><li>libc follows <code>/etc/nsswitch.conf</code> (files, DNS, mDNS, whatever)</li><li><code>/etc/resolv.conf</code> points at a local stub, or a real resolver</li><li><code>systemd-resolved</code>, <code>dnsmasq</code>, <code>unbound</code>, CoreDNS, or a cloud-provided resolver does the actual work</li></ul><p>In cloud networks, there&rsquo;s usually a magic resolver IP.</p><ul><li>AWS VPC resolver: <code>169.254.169.253</code></li><li>Azure: <code>168.63.129.16</code></li></ul><p>If a security group, NACL, or egress policy blocks that, everything breaks in ways that look unrelated.</p><p>On modern Linux, start with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span>resolvectl status
</span></span><span style=display:flex><span>cat /etc/resolv.conf
</span></span><span style=display:flex><span>cat /etc/nsswitch.conf
</span></span></code></pre></div><p>In Kubernetes you add another layer:</p><ul><li>Pod uses <code>/etc/resolv.conf</code> injected by kubelet</li><li>CoreDNS answers cluster names and forwards everything else</li><li><code>ndots</code> and search paths can multiply queries and create NXDOMAIN storms</li></ul><h2 id=how-dns-breaks-the-stuff-you-see-weekly>How DNS Breaks (The Stuff You See Weekly)<a href=#how-dns-breaks-the-stuff-you-see-weekly class=hanchor arialabel=Anchor>#</a></h2><h3 id=1-wrong-record-wrong-ttl-wrong-place>1. Wrong record, wrong TTL, wrong place<a href=#1-wrong-record-wrong-ttl-wrong-place class=hanchor arialabel=Anchor>#</a></h3><p>Most outages are self-inflicted:</p><ul><li>An A/AAAA record points at an old load balancer</li><li>A CNAME points at something that no longer exists</li><li>A TTL is set to 86400 &ldquo;because stability&rdquo; and now you&rsquo;re stuck with it</li><li>Someone edits the public zone when they meant the internal zone</li></ul><p>If you only take one thing from this post: treat DNS changes like deployments. Review them, stage them, and have a rollback.</p><h3 id=2-resolver-problems-everything-looks-down>2. Resolver problems (everything looks down)<a href=#2-resolver-problems-everything-looks-down class=hanchor arialabel=Anchor>#</a></h3><p>Authoritative servers can be healthy and you can still be dead if your resolvers are:</p><ul><li>Overloaded</li><li>Misconfigured (bad forwarders, broken recursion)</li><li>Dropping UDP fragments (DNS responses get larger than you think)</li><li>Timing out because of upstream issues</li></ul><p>Symptoms look like &ldquo;random&rdquo; failures:</p><ul><li>One office can&rsquo;t log in</li><li>Only some mobile users can&rsquo;t reach the API</li><li>Half your pods can&rsquo;t pull images</li></ul><h3 id=3-mtu-and-fragmentation-the-invisible-pain>3. MTU and fragmentation (the invisible pain)<a href=#3-mtu-and-fragmentation-the-invisible-pain class=hanchor arialabel=Anchor>#</a></h3><p>Modern DNS responses can be large:</p><ul><li>DNSSEC adds signatures</li><li>Lots of records (or bad &ldquo;kitchen sink&rdquo; zones)</li><li>TXT records for SPF, DKIM, verification tokens</li></ul><p>Large UDP responses fragment. Firewalls drop fragments. Clients retry over TCP. Latency spikes. Things flap.</p><p>You don&rsquo;t need a fancy root cause. You need to look at packets.</p><h3 id=4-split-horizon-and-private-zones-cloud-favourite>4. Split-horizon and private zones (cloud favourite)<a href=#4-split-horizon-and-private-zones-cloud-favourite class=hanchor arialabel=Anchor>#</a></h3><p>Cloud DNS makes it easy to have the same name mean different things in different places.</p><p>That is useful. It&rsquo;s also how you accidentally take production down:</p><ul><li>Private zone exists but isn&rsquo;t linked to the right VPC/VNet</li><li>You created a private record for <code>api.example.com</code> and forgot the public one still points elsewhere</li><li>A migration flips a CNAME to a private endpoint name and half your clients can&rsquo;t resolve it</li></ul><p>Symptoms:</p><ul><li>Works from inside the VPC/VNet</li><li>Fails from laptops, CI runners, or the other VPC you forgot exists</li></ul><h3 id=5-kubernetes-dns-pain-ndots-search-paths-coredns>5. Kubernetes DNS pain (ndots, search paths, CoreDNS)<a href=#5-kubernetes-dns-pain-ndots-search-paths-coredns class=hanchor arialabel=Anchor>#</a></h3><p>Kubernetes can turn a small DNS problem into a big one.</p><p>Common failure modes:</p><ul><li><code>ndots:5</code> plus long search paths means a single lookup turns into multiple NXDOMAIN queries</li><li>CoreDNS forwards to an upstream resolver that rate limits or times out</li><li>NodeLocal DNSCache isn&rsquo;t deployed, so every pod hammers CoreDNS directly</li><li>Someone &ldquo;optimises&rdquo; CoreDNS and breaks forwarding</li></ul><h2 id=how-attackers-use-dns>How Attackers Use DNS<a href=#how-attackers-use-dns class=hanchor arialabel=Anchor>#</a></h2><p>DNS is useful to attackers because it&rsquo;s everywhere and rarely monitored properly.</p><h3 id=1-dns-as-a-beacon>1. DNS as a beacon<a href=#1-dns-as-a-beacon class=hanchor arialabel=Anchor>#</a></h3><p>Malware loves a simple pattern: &ldquo;every 60 seconds, resolve a name and do what it says&rdquo;.</p><p>It blends in because DNS traffic is constant. If you&rsquo;re not logging it, it might as well not exist.</p><h3 id=2-dns-tunnelling-and-exfiltration>2. DNS tunnelling and exfiltration<a href=#2-dns-tunnelling-and-exfiltration class=hanchor arialabel=Anchor>#</a></h3><p>If outbound TCP is locked down but DNS is wide open, attackers will use DNS for data exfiltration.</p><p>The easy signals:</p><ul><li>Very long subdomains</li><li>High entropy labels (looks like base32/base64)</li><li>Lots of TXT queries</li><li>A single client doing hundreds of queries a minute to one domain</li></ul><p>Real numbers you can alert on:</p><ul><li>NXDOMAIN rate jumps from 1-3% to 20%+</li><li>TXT query share goes from ~0.1-1% to 5%+</li><li>Average query name length jumps from ~20-40 chars to 80+</li></ul><h3 id=3-dns-spoofing-inside-your-network>3. DNS spoofing inside your network<a href=#3-dns-spoofing-inside-your-network class=hanchor arialabel=Anchor>#</a></h3><p>If an attacker can control what a client resolves, they can redirect:</p><ul><li>Software updates</li><li>SSO endpoints</li><li>Internal APIs</li></ul><p>This isn&rsquo;t always &ldquo;evil nation state&rdquo;. Sometimes it&rsquo;s:</p><ul><li>Someone stood up a rogue DHCP server</li><li>A laptop runs a local DNS forwarder and starts answering queries</li><li>A Wi-Fi network hands out its own resolver</li></ul><h3 id=4-domain-takeover-by-deletion>4. Domain takeover by deletion<a href=#4-domain-takeover-by-deletion class=hanchor arialabel=Anchor>#</a></h3><p>This one hurts because it&rsquo;s boring.</p><p>You delete a service. You forget the DNS records. Six months later the external resource name becomes available again (cloud storage, SaaS, whatever). Someone else claims it. Your CNAME still points at it.</p><p>Now you have a clean, authenticated looking hostname pointing at an attacker-controlled endpoint.</p><h2 id=monitoring-that-actually-matters>Monitoring That Actually Matters<a href=#monitoring-that-actually-matters class=hanchor arialabel=Anchor>#</a></h2><p>If you already read my Prometheus post, this is the same idea: monitor what tells you you&rsquo;re broken, not what makes dashboards look tidy.</p><p>You want to monitor two things:</p><ol><li>DNS as a service (availability and latency)</li><li>DNS as behaviour (what clients are doing)</li></ol><h3 id=service-metrics>Service metrics<a href=#service-metrics class=hanchor arialabel=Anchor>#</a></h3><p>Start with these:</p><ul><li>Query rate (QPS)</li><li>Latency percentiles (P50/P95/P99)</li><li>SERVFAIL rate</li><li>NXDOMAIN rate</li><li>TCP fallback rate (if this spikes, fragmentation or upstream problems are likely)</li></ul><h3 id=behaviour-metrics>Behaviour metrics<a href=#behaviour-metrics class=hanchor arialabel=Anchor>#</a></h3><p>These catch attacks and misconfigurations:</p><ul><li>Top queried domains (internal and external)</li><li>New domains seen (first time in 7 days)</li><li>Query type distribution (A/AAAA vs TXT vs ANY)</li><li>Query name length distribution</li><li>Clients with unusually high query volume</li></ul><p>Quick cheat sheet:</p><table><thead><tr><th>Signal</th><th style=text-align:right>Normal-ish baseline</th><th>When to worry</th></tr></thead><tbody><tr><td>NXDOMAIN rate</td><td style=text-align:right>1-5%</td><td>15-20%+ sustained</td></tr><tr><td>SERVFAIL rate</td><td style=text-align:right>near zero</td><td>anything sustained</td></tr><tr><td>TCP fallback</td><td style=text-align:right>low</td><td>spikes correlate with latency</td></tr><tr><td>TXT share</td><td style=text-align:right>low</td><td>sudden jump</td></tr><tr><td>New domains</td><td style=text-align:right>depends</td><td>sudden spike from one client</td></tr></tbody></table><p>None of these numbers are universal. They&rsquo;re good starting points. Baseline your environment and alert on change.</p><h3 id=collecting-dns-logs-without-losing-your-mind>Collecting DNS logs without losing your mind<a href=#collecting-dns-logs-without-losing-your-mind class=hanchor arialabel=Anchor>#</a></h3><p>You don&rsquo;t need to store every query forever. You do need enough to answer &ldquo;what changed?&rdquo;.</p><p>Practical options:</p><ul><li>Sample logs (eg 1 in 100 queries) plus full logs on errors</li><li>Full logs for internal zones only</li><li>Full logs for a short retention window (eg 24-72 hours)</li></ul><p>If you can&rsquo;t answer &ldquo;which clients queried this domain in the last hour&rdquo;, you will have a bad time during an incident.</p><p>Cloud note: if you&rsquo;re using managed resolvers, turn on resolver query logging (whatever your cloud calls it) and keep at least a short retention window. It saves you from guessing.</p><h3 id=cloud-dns-what-to-switch-on>Cloud DNS: what to switch on<a href=#cloud-dns-what-to-switch-on class=hanchor arialabel=Anchor>#</a></h3><p>You want two things from cloud DNS: query logs, and change logs.</p><p>Practical defaults:</p><ul><li>AWS (Route 53 Resolver): enable Resolver query logging to CloudWatch Logs (or S3) for the VPCs that matter. If you use Route 53 Resolver DNS Firewall, log the blocks.</li><li>Azure: the built-in resolver doesn&rsquo;t give you much visibility. If you need query logs, route DNS through something you control and can log (Azure DNS Private Resolver, Azure Firewall DNS proxy, or your own Unbound/BIND) and send diagnostics to Log Analytics.</li><li>GCP: enable VPC DNS logging (DNS policy with logging enabled) so you can see what instances are asking. If you run Cloud DNS private zones, keep the zone change history and log admin activity.</li></ul><h2 id=defences-that-work-and-dont-require-heroics>Defences That Work (And Don&rsquo;t Require Heroics)<a href=#defences-that-work-and-dont-require-heroics class=hanchor arialabel=Anchor>#</a></h2><h3 id=1-control-the-resolvers>1. Control the resolvers<a href=#1-control-the-resolvers class=hanchor arialabel=Anchor>#</a></h3><p>Pick where clients are allowed to resolve names, then enforce it:</p><ul><li>Block outbound DNS to the internet from client networks (UDP/TCP 53)</li><li>Explicitly allow only your resolvers to talk out</li><li>Decide how you handle DoH/DoT (more on this below)</li></ul><p>Linux and cloud version of this:</p><ul><li>In VPC/VNet: only allow DNS egress to your resolver tier and the cloud resolver IPs you actually use</li><li>In Kubernetes: prefer NodeLocal DNSCache, and set sane limits on CoreDNS</li></ul><h3 id=2-use-rpz--dns-filtering-where-it-helps>2. Use RPZ / DNS filtering where it helps<a href=#2-use-rpz--dns-filtering-where-it-helps class=hanchor arialabel=Anchor>#</a></h3><p>RPZ (Response Policy Zones) is the unglamorous workhorse. You can block known bad domains at the resolver.</p><p>Example idea (BIND style):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>response-policy { zone &#34;rpz.local&#34;; };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>zone &#34;rpz.local&#34; {
</span></span><span style=display:flex><span>  type master;
</span></span><span style=display:flex><span>  file &#34;/etc/bind/db.rpz.local&#34;;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>Don&rsquo;t pretend this stops targeted attackers. It stops commodity garbage and buys you time.</p><h3 id=3-dnssec-useful-but-not-a-magic-shield>3. DNSSEC: useful, but not a magic shield<a href=#3-dnssec-useful-but-not-a-magic-shield class=hanchor arialabel=Anchor>#</a></h3><p>DNSSEC helps with integrity between resolvers and authoritative servers.</p><p>It does not:</p><ul><li>Stop you publishing the wrong record</li><li>Fix your resolver being down</li><li>Stop someone inside your network handing out a rogue resolver</li></ul><p>Also, DNSSEC can make fragmentation problems worse if your network is fragile. Test it.</p><h3 id=4-dohdot-decide-what-you-want>4. DoH/DoT: decide what you want<a href=#4-dohdot-decide-what-you-want class=hanchor arialabel=Anchor>#</a></h3><p>Browsers and clients can bypass your resolver via DNS-over-HTTPS (DoH) or DNS-over-TLS (DoT).</p><p>If you rely on DNS logging for detection, that bypass matters.</p><p>You have three choices:</p><ol><li>Allow it and accept reduced visibility</li><li>Block known DoH endpoints and enforce your resolvers</li><li>Provide your own DoH endpoint and control it</li></ol><p>None are perfect. Pick based on your threat model and the politics of your desktop team.</p><h2 id=incident-response-dns-edition>Incident Response: DNS Edition<a href=#incident-response-dns-edition class=hanchor arialabel=Anchor>#</a></h2><p>This is the bit you want at 3am.</p><h3 id=1-confirm-its-dns-dont-guess>1. Confirm it&rsquo;s DNS (don&rsquo;t guess)<a href=#1-confirm-its-dns-dont-guess class=hanchor arialabel=Anchor>#</a></h3><p>From a broken client:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span>dig +time<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> +tries<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> example.com
</span></span><span style=display:flex><span>dig +time<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> +tries<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> @your-resolver-ip example.com
</span></span><span style=display:flex><span>dig +time<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> +tries<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> @1.1.1.1 example.com
</span></span></code></pre></div><p>If querying your resolver fails but public resolvers work, your resolver path is the problem.</p><p>If everything fails, check connectivity and upstream.</p><p>On Linux, confirm the machine is using the resolver you think it is:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span>resolvectl status
</span></span><span style=display:flex><span>getent hosts example.com
</span></span></code></pre></div><h3 id=2-check-ttl-and-caching-reality>2. Check TTL and caching reality<a href=#2-check-ttl-and-caching-reality class=hanchor arialabel=Anchor>#</a></h3><p>If you changed a record five minutes ago and TTL is one hour, the internet did not &ldquo;ignore&rdquo; your fix. You told it not to look again.</p><h3 id=3-look-for-servfail-timeouts-and-tcp-fallback>3. Look for SERVFAIL, timeouts, and TCP fallback<a href=#3-look-for-servfail-timeouts-and-tcp-fallback class=hanchor arialabel=Anchor>#</a></h3><p>When your resolvers start falling back to TCP, latency climbs and everything downstream starts timing out.</p><h3 id=4-contain-and-stabilise>4. Contain and stabilise<a href=#4-contain-and-stabilise class=hanchor arialabel=Anchor>#</a></h3><p>Practical stabilisation steps:</p><ul><li>Fail over clients to a known-good resolver pool</li><li>Temporarily disable DNSSEC validation if it&rsquo;s breaking resolution (document it, then fix properly)</li><li>Rate limit abusive clients if one host is melting your resolver</li></ul><h3 id=5-hunt-the-cause>5. Hunt the cause<a href=#5-hunt-the-cause class=hanchor arialabel=Anchor>#</a></h3><p>The usual culprits:</p><ul><li>A broken forwarder</li><li>A firewall change dropping fragments</li><li>An upstream resolver outage</li><li>A bad zone change</li><li>One &ldquo;helpful&rdquo; device handing out DNS settings via DHCP</li></ul><p>Cloud and Kubernetes extras:</p><ul><li>Someone blocked the cloud resolver IP in an egress policy</li><li>Private zone link got removed or never existed</li><li>CoreDNS is overloaded, crashlooping, or forwarding to a dead upstream</li></ul><h2 id=the-boring-truth>The Boring Truth<a href=#the-boring-truth class=hanchor arialabel=Anchor>#</a></h2><p>DNS security is not glamorous. It&rsquo;s change control, visibility, and making sure name resolution keeps working when everything else is on fire.</p><p>If you do nothing else:</p><ul><li>Run your own resolvers and make clients use them</li><li>Log enough to investigate incidents</li><li>Alert on NXDOMAIN, SERVFAIL, and latency percentiles</li><li>Treat DNS records like production config, because that&rsquo;s what they are</li></ul><hr><p><em>If you&rsquo;re already using Prometheus, the DNS metrics fit nicely next to the rest of your ops signals. If you&rsquo;re not, start small. A few graphs and three good alerts beat a SIEM rule nobody reads.</em></p></div></div><div class=related-posts style="margin-top:3rem;padding-top:2rem;border-top:1px solid #333"><h3>Related Posts</h3><ul style=list-style:none;padding:0><li style=margin-bottom:1rem><a href=https://gazsecops.github.io/posts/incident-response-what-actually-works/>Incident Response: What Actually Works at 3am</a>
<span style=color:#999;font-size:.9rem>- 2 Jul 2025</span><div style=font-size:.85rem;color:#666;margin-top:.25rem><span style=margin-right:.5rem>#security</span>
<span style=margin-right:.5rem>#incident-response</span>
<span style=margin-right:.5rem>#operations</span>
<span style=margin-right:.5rem>#linux</span>
<span style=margin-right:.5rem>#cloud</span></div></li><li style=margin-bottom:1rem><a href=https://gazsecops.github.io/posts/stepca-running-internal-pki/>Smallstep step-ca: Running Internal PKI Without Losing Your Mind</a>
<span style=color:#999;font-size:.9rem>- 28 Oct 2025</span><div style=font-size:.85rem;color:#666;margin-top:.25rem><span style=margin-right:.5rem>#security</span>
<span style=margin-right:.5rem>#pki</span>
<span style=margin-right:.5rem>#tls</span>
<span style=margin-right:.5rem>#certificates</span>
<span style=margin-right:.5rem>#linux</span>
<span style=margin-right:.5rem>#cloud</span>
<span style=margin-right:.5rem>#operations</span></div></li><li style=margin-bottom:1rem><a href=https://gazsecops.github.io/posts/prometheus-security-monitoring/>Prometheus for Security: Monitoring What Actually Matters</a>
<span style=color:#999;font-size:.9rem>- 18 Oct 2024</span><div style=font-size:.85rem;color:#666;margin-top:.25rem><span style=margin-right:.5rem>#security</span>
<span style=margin-right:.5rem>#monitoring</span>
<span style=margin-right:.5rem>#prometheus</span>
<span style=margin-right:.5rem>#linux</span>
<span style=margin-right:.5rem>#operations</span></div></li><li style=margin-bottom:1rem><a href=https://gazsecops.github.io/posts/zero-trust-what-it-actually-means/>Zero Trust: What It Actually Means When You Have to Implement It</a>
<span style=color:#999;font-size:.9rem>- 5 Aug 2025</span><div style=font-size:.85rem;color:#666;margin-top:.25rem><span style=margin-right:.5rem>#security</span>
<span style=margin-right:.5rem>#zero-trust</span>
<span style=margin-right:.5rem>#networking</span>
<span style=margin-right:.5rem>#identity</span>
<span style=margin-right:.5rem>#cloud</span>
<span style=margin-right:.5rem>#operations</span></div></li><li style=margin-bottom:1rem><a href=https://gazsecops.github.io/posts/password-managers-2025/>Password Managers in 2025: What Actually Works</a>
<span style=color:#999;font-size:.9rem>- 15 Apr 2025</span><div style=font-size:.85rem;color:#666;margin-top:.25rem><span style=margin-right:.5rem>#security</span>
<span style=margin-right:.5rem>#passwords</span>
<span style=margin-right:.5rem>#vault</span>
<span style=margin-right:.5rem>#linux</span>
<span style=margin-right:.5rem>#operations</span></div></li></ul></div><div class=pagination><div class=pagination__title><span class=pagination__title-h></span><hr></div><div class=pagination__buttons><a href=https://gazsecops.github.io/posts/incident-response-what-actually-works/ class="button inline prev">&lt; [<span class=button__text>Incident Response: What Actually Works at 3am</span>]
</a>::
<a href=https://gazsecops.github.io/posts/oauth2-security-pitfalls/ class="button inline next">[<span class=button__text>OAuth 2.0 Security: What Actually Breaks</span>] ></a></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2026</span></div><div class=build-info><span class=build-commit>e733073</span><span class=build-date>2026-02-12 12:33 UTC</span></div></div></footer></div></body></html>